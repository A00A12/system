<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸šåŠ¡å‘˜ç³»ç»Ÿ | æŸç››å…¨çƒåˆä¼™äººç³»ç»Ÿ v5.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.8/dist/umd/supabase.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .vip-gradient { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); }
        .service-gradient { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(241, 245, 249, 1); }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px);
            display: flex; align-items: center; justify-content: center; z-index: 9999;
        }
        .loading-spinner {
            width: 50px; height: 50px; border: 4px solid #e2e8f0;
            border-top-color: #4f46e5; border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .toast {
            position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(100px);
            background: #1e293b; color: white; padding: 12px 24px; border-radius: 12px;
            font-size: 14px; font-weight: 600; z-index: 10000; opacity: 0; transition: all 0.3s ease;
        }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
    </style>
</head>
<body class="text-slate-900 antialiased h-screen flex overflow-hidden">

    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <aside class="w-64 bg-white border-r border-slate-100 hidden md:flex flex-col justify-between h-full z-30 shadow-sm relative">
        <div>
            <div class="h-20 flex items-center px-8 border-b border-slate-50">
                <span class="text-xl font-black text-indigo-600 tracking-tight">æŸç››ä¸šåŠ¡ <span class="text-xs text-slate-400 font-medium">v5.0</span></span>
            </div>
            <nav class="p-4 space-y-2 mt-4" id="nav-menu">
                <button onclick="switchTab('overview')" id="nav-overview" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-indigo-50 text-indigo-600 font-bold transition-all">
                    <span class="text-lg">ğŸ“Š</span> ä¸šç»©æ€»è§ˆ
                </button>
                <button onclick="switchTab('orders')" id="nav-orders" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 font-medium transition-all">
                    <span class="text-lg">ğŸ“¦</span> è®¢å•æ˜ç»†
                </button>
                <button onclick="switchTab('referral')" id="nav-referral" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 font-medium transition-all">
                    <span class="text-lg">ğŸ¤</span> å‘å±•å®¢æˆ·
                </button>
                <button onclick="switchTab('profile')" id="nav-profile" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 font-medium transition-all">
                    <span class="text-lg">ğŸ‘¤</span> ä¸ªäººä¸­å¿ƒ
                </button>
            </nav>
        </div>
        <div class="p-4 border-t border-slate-50">
            <div onclick="switchTab('profile')" class="flex items-center gap-3 px-4 py-3 rounded-xl bg-slate-50 cursor-pointer hover:bg-slate-100 transition-all">
                <div id="userAvatar" class="w-10 h-10 rounded-full bg-indigo-200 flex items-center justify-center font-bold text-indigo-700">--</div>
                <div class="text-left">
                    <div id="userName" class="text-sm font-bold text-slate-800">åŠ è½½ä¸­...</div>
                    <div id="userId" class="text-[10px] text-slate-500 uppercase">ID: --</div>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 h-full overflow-y-auto relative bg-[#f8fafc]">
        
        <header class="h-20 bg-white/80 backdrop-blur-md border-b border-slate-100 flex items-center justify-between px-8 sticky top-0 z-20">
            <h1 class="text-xl font-extrabold text-slate-800" id="page-title">ä¸šç»©æ€»è§ˆ</h1>
            <div class="flex items-center gap-6">
                <div class="text-right border-r pr-6 border-slate-100 hidden sm:block">
                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">XTransfer æ‰§è¡Œæ±‡ç‡ (-1%)</p>
                    <p id="exchangeRate" class="text-sm font-black text-indigo-600">1 USD â‰ˆ Â¥7.05</p>
                </div>
                
                <div class="relative" id="notification-container">
                    <button onclick="toggleNotifications()" class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-xl hover:bg-slate-100 relative transition-all cursor-pointer">
                        ğŸ””<span id="unread-dot" class="absolute top-2 right-2 w-2 h-2 bg-indigo-500 rounded-full border border-white animate-pulse"></span>
                    </button>

                    <div id="notification-panel" class="hidden absolute right-0 mt-3 w-80 bg-white rounded-2xl shadow-2xl border border-slate-100 overflow-hidden z-50 transform opacity-0 scale-95 transition-all duration-200 origin-top-right">
                        <div class="p-4 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
                            <h3 class="font-bold text-slate-800 text-sm">ç³»ç»Ÿé€šçŸ¥</h3>
                            <button onclick="markAllRead()" class="text-[10px] font-bold text-indigo-600 hover:text-indigo-800">å…¨éƒ¨æ ‡ä¸ºå·²è¯»</button>
                        </div>
                        <div id="notificationList" class="max-h-80 overflow-y-auto">
                            </div>
                        <div class="p-3 text-center border-t border-slate-50 bg-white">
                            <button class="text-[10px] font-bold text-slate-400 hover:text-indigo-600 transition-colors">æŸ¥çœ‹æ‰€æœ‰å†å²é€šçŸ¥</button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="p-8 max-w-7xl mx-auto">

            <div id="tab-overview" class="tab-content active space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="vip-gradient rounded-3xl p-6 text-white shadow-lg shadow-indigo-200 relative overflow-hidden">
                        <div class="absolute -right-6 -top-6 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                        <p class="text-[10px] font-bold uppercase tracking-widest text-indigo-100 mb-1 relative z-10">æœ¬æœˆé¢„ä¼°æ€»ä½£é‡‘ (æœåŠ¡+é‡‡è´­)</p>
                        <h3 id="monthCommission" class="text-3xl font-black mb-4 relative z-10">Â¥0.00</h3>
                        <button onclick="switchTab('orders')" class="text-[10px] bg-white/20 hover:bg-white/30 px-3 py-1 rounded-full w-fit relative z-10 transition-colors">æŸ¥çœ‹æ˜ç»† â”</button>
                    </div>
                    
                    <div class="glass-card rounded-3xl p-6 shadow-sm hover:-translate-y-1 transition-transform">
                        <div class="flex justify-between items-start">
                            <p class="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-1">é‡‡è´­ç±»ç´¯è®¡æ¯›åˆ© (é˜¶æ¢¯)</p>
                            <span id="commissionTier" class="px-2 py-1 bg-indigo-50 text-indigo-600 rounded text-[10px] font-bold">10% èµ·æ­¥æ¡£</span>
                        </div>
                        <h3 id="totalProcurementProfit" class="text-2xl font-black text-slate-800 mt-1">Â¥0</h3>
                        <p id="nextTierInfo" class="text-[10px] mt-2 text-slate-500 font-medium">è·ç¦» 12% æ¡£ä½è¿˜å·® Â¥0</p>
                        <div class="w-full h-1.5 bg-slate-100 rounded-full mt-2 overflow-hidden">
                            <div id="tierProgress" class="h-full bg-indigo-500 w-0 rounded-full"></div>
                        </div>
                    </div>

                    <div class="glass-card rounded-3xl p-6 shadow-sm hover:-translate-y-1 transition-transform border-l-4 border-amber-400">
                        <div class="flex justify-between items-start">
                            <p class="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-1">æœåŠ¡ç±»ç´¯è®¡æ¯›åˆ©</p>
                            <span class="px-2 py-1 bg-amber-50 text-amber-600 rounded text-[10px] font-bold border border-amber-100">40% ææˆ</span>
                        </div>
                        <h3 id="totalServiceProfit" class="text-2xl font-black text-slate-800 mt-1">Â¥0</h3>
                        <p class="text-[10px] mt-2 text-slate-400 font-medium">å«å¯¼æ¸¸/åŒ»ç–—/æ•°å­—åŒ–/ç”¨è½¦ç­‰</p>
                        <div class="w-full h-1.5 bg-slate-100 rounded-full mt-2 overflow-hidden">
                            <div class="h-full bg-amber-400 w-full rounded-full opacity-80"></div>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-900 rounded-3xl p-8 text-white relative overflow-hidden shadow-xl">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-indigo-500/20 rounded-full blur-3xl -mr-20 -mt-20"></div>
                    <h3 class="text-lg font-bold mb-4 relative z-10">ä½£é‡‘æ¨¡æ‹Ÿé¢„ä¼°å™¨ (V5æ ‡å‡†)</h3>
                    <p class="text-xs text-slate-400 mb-6 relative z-10">é‡‡è´­ç±»æŒ‰é˜¶æ¢¯æ¯›åˆ©è¯•ç®—ï¼ŒæœåŠ¡ç±»æŒ‰å›ºå®šæ¯”ä¾‹è¯•ç®—ã€‚</p>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 relative z-10">
                        <input type="number" id="sim-amount" placeholder="è¾“å…¥å¤–å¸é‡‘é¢" class="bg-white/10 border border-white/20 rounded-xl px-4 py-3 outline-none focus:border-indigo-500 transition-all text-sm">
                        <select id="sim-currency" class="bg-white/10 border border-white/20 rounded-xl px-4 py-3 outline-none focus:border-indigo-500 transition-all text-sm">
                            <option class="text-slate-900" value="USD">USD - ç¾å…ƒ</option>
                            <option class="text-slate-900" value="EUR">EUR - æ¬§å…ƒ</option>
                            <option class="text-slate-900" value="GBP">GBP - è‹±é•‘</option>
                            <option class="text-slate-900" value="HKD">HKD - æ¸¯å¸</option>
                        </select>
                        <select id="sim-type" class="bg-white/10 border border-white/20 rounded-xl px-4 py-3 outline-none focus:border-indigo-500 transition-all text-sm">
                            <option class="text-slate-900" value="sourcing">é‡‡è´­ç±» (é˜¶æ¢¯ææˆ)</option>
                            <option class="text-slate-900" value="service">æœåŠ¡ç±» (40%ç›´æ)</option>
                        </select>
                        <button onclick="calculateCommission()" class="bg-indigo-600 hover:bg-indigo-500 transition-all rounded-xl font-bold text-sm shadow-lg shadow-indigo-500/30">ç«‹å³è¯•ç®—</button>
                    </div>
                    
                    <div id="sim-result" class="hidden relative z-10 mt-6 transition-all duration-300"></div>
                </div>
            </div>

            <div id="tab-orders" class="tab-content space-y-6">
                <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
                    <div class="p-6 border-b border-slate-50 bg-slate-50/50 flex justify-between items-center">
                        <div>
                            <h3 class="font-bold text-slate-800">ä¸šç»©è®¢å•æ˜ç»†</h3>
                            <p class="text-[10px] text-slate-400 mt-1">ä¸šåŠ¡å‘˜å…·å¤‡"äº§å“/ç‰©æµæˆæœ¬"çš„åªè¯»æƒé™ï¼Œä»¥ä¾¿è¿›è¡Œåˆ©æ¶¦åˆ†æã€‚</p>
                        </div>
                        <div class="relative">
                            <input type="text" id="orderSearch" placeholder="æœç´¢è®¢å•ç¼–å·..." class="text-xs border border-slate-200 rounded-lg pl-8 pr-3 py-2 outline-none focus:border-indigo-500 transition-all">
                            <span class="absolute left-2.5 top-2 text-slate-400">ğŸ”</span>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm border-collapse">
                            <thead>
                                <tr class="text-[10px] uppercase tracking-widest text-slate-400 font-bold border-b border-slate-100 bg-white">
                                    <th class="p-5 pl-8">è®¢å•ID / æ—¥æœŸ</th>
                                    <th class="p-5">ä¸šåŠ¡ç±»å‹</th>
                                    <th class="p-5 text-right bg-slate-50/50">å¤–å¸é‡‘é¢</th>
                                    <th class="p-5 text-right bg-slate-50/50">äººæ°‘å¸é‡‘é¢</th>
                                    <th class="p-5 pr-12 text-right">çŠ¶æ€</th>
                                </tr>
                            </thead>
                            <tbody id="ordersTableBody" class="text-slate-700 font-medium">
                                </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-referral" class="tab-content space-y-6">
                <div class="bg-gradient-to-r from-indigo-600 to-purple-600 rounded-3xl p-8 text-white flex flex-col md:flex-row justify-between items-center gap-8 shadow-xl">
                    <div class="space-y-2 text-center md:text-left">
                        <p class="text-[10px] font-bold text-indigo-200 uppercase tracking-widest bg-white/10 px-3 py-1 rounded-full w-fit mx-auto md:mx-0">My Referral Code</p>
                        <h2 id="myReferralCode" class="text-4xl md:text-5xl font-mono font-black tracking-widest drop-shadow-md">----</h2>
                        <p class="text-sm text-indigo-100 max-w-md mt-2">å®¢æˆ·æ³¨å†Œæ—¶é€šè¿‡ <code class="bg-white/20 px-1 rounded">referrer_id</code> ç»‘å®šä¸ºæ‚¨åä¸‹çš„å®¢æˆ·ã€‚</p>
                    </div>
                    <button onclick="copyReferralLink()" class="bg-white text-indigo-700 px-8 py-4 rounded-xl font-bold shadow-lg hover:bg-indigo-50 transition-all text-sm">å¤åˆ¶ä¸“å±é‚€è¯·é“¾æ¥</button>
                </div>

                <div class="bg-white p-8 rounded-3xl border border-slate-100 shadow-sm">
                    <div class="flex justify-between items-end mb-6">
                        <div>
                            <h3 class="font-bold text-slate-800 text-lg">ğŸ“ˆ æ¨èææˆç­‰çº§</h3>
                            <p class="text-xs text-slate-400 mt-1">åŸºäºä¸‹çº§å®¢æˆ·ç´¯è®¡æ¶ˆè´¹é¢è‡ªåŠ¨å‡çº§ææˆæ¯”ä¾‹ã€‚</p>
                        </div>
                        <div class="text-right">
                            <span id="refRateDisplay" class="text-2xl font-black text-indigo-600">2%</span>
                            <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">å½“å‰æ¯”ä¾‹</p>
                        </div>
                    </div>
                    <div class="relative pt-1">
                        <div class="flex mb-2 items-center justify-between text-xs font-bold">
                            <div id="refProgSum" class="text-indigo-600">ç´¯è®¡æ¨èæ¶ˆè´¹: Â¥0</div>
                            <div id="refNextLabel" class="text-slate-400 italic">--</div>
                        </div>
                        <div class="overflow-hidden h-3 mb-4 text-xs flex rounded-full bg-slate-100">
                            <div id="refProgressBar" style="width:0%" class="bg-indigo-500 transition-all duration-700"></div>
                        </div>
                        <div class="grid grid-cols-4 text-[9px] font-bold text-slate-400 uppercase tracking-tighter">
                            <div>Â¥0 (2%)</div><div class="text-center">Â¥2ä¸‡ (3%)</div><div class="text-center">Â¥10ä¸‡ (4%)</div><div class="text-right">Â¥50ä¸‡ (5%)</div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden flex flex-col">
                        <div class="p-6 border-b border-slate-50 flex justify-between items-center bg-slate-50/30">
                            <h3 class="font-bold text-slate-800">ğŸ‘¥ æˆ‘æ‹›å‹Ÿçš„å®¢æˆ·</h3>
                            <span id="recruitCount" class="bg-indigo-50 text-indigo-600 px-3 py-1 rounded-full text-xs font-bold">0 ä½</span>
                        </div>
                        <div class="max-h-[400px] overflow-y-auto">
                            <table class="w-full text-left text-sm border-collapse">
                                <thead class="bg-slate-50 text-[10px] uppercase font-bold text-slate-400 sticky top-0">
                                    <tr>
                                        <th class="px-6 py-4">å®¢æˆ·å§“å</th>
                                        <th class="px-6 py-4">æ³¨å†Œæ—¥æœŸ</th>
                                        <th class="px-6 py-4 text-right">çŠ¶æ€</th>
                                    </tr>
                                </thead>
                                <tbody id="recruitListBody" class="text-slate-600"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden flex flex-col">
                        <div class="p-6 border-b border-slate-50 flex justify-between items-center bg-slate-50/30">
                            <h3 class="font-bold text-slate-800">ğŸ’° æ¨èå¥–åŠ±è®°å½•</h3>
                            <span id="refTotalPayout" class="text-green-600 font-black text-sm">Â¥0.00</span>
                        </div>
                        <div class="max-h-[400px] overflow-y-auto">
                            <table class="w-full text-left text-sm border-collapse">
                                <thead class="bg-slate-50 text-[10px] uppercase font-bold text-slate-400 sticky top-0">
                                    <tr>
                                        <th class="px-6 py-4">æ¥æºè®¢å•</th>
                                        <th class="px-6 py-4 text-center">æ¯”ä¾‹</th>
                                        <th class="px-6 py-4 text-right">å¥–é‡‘</th>
                                    </tr>
                                </thead>
                                <tbody id="payoutListBody" class="text-slate-600"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-profile" class="tab-content space-y-6">
                <div class="bg-white rounded-3xl p-8 border border-slate-100 shadow-sm flex flex-col md:flex-row items-center gap-8">
                    <div id="profileAvatar" class="w-24 h-24 rounded-full bg-indigo-100 flex items-center justify-center text-4xl font-black text-indigo-600 shrink-0">--</div>
                    <div class="flex-1 text-center md:text-left">
                        <h2 id="profileName" class="text-2xl font-extrabold text-slate-800 mb-1">åŠ è½½ä¸­...</h2>
                        <p class="text-sm font-bold text-slate-500 mb-4">ç³»ç»Ÿè§’è‰²ï¼š<span class="text-indigo-600">ä¸šåŠ¡å‘˜ (Salesperson)</span></p>
                        <div class="flex flex-wrap gap-3 justify-center md:justify-start">
                            <span id="profilePhone" class="px-3 py-1 bg-slate-50 border border-slate-200 rounded-lg text-xs font-bold text-slate-600">æ‰‹æœºï¼š--</span>
                            <span id="profileId" class="px-3 py-1 bg-slate-50 border border-slate-200 rounded-lg text-xs font-bold text-slate-600">å®¢æˆ·ç¼–å·ï¼š--</span>
                            <span class="px-3 py-1 bg-green-50 border border-green-200 rounded-lg text-xs font-bold text-green-600">çŠ¶æ€ï¼šå·²é€šè¿‡å®¡æ ¸</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white rounded-3xl p-8 border border-slate-100 shadow-sm">
                            <h3 class="font-bold text-slate-800 mb-2 text-lg">è”ç³»æ–¹å¼</h3>
                            <p class="text-xs text-slate-400 mb-6">å®Œå–„ä»¥ä¸‹è”ç³»æ–¹å¼ï¼Œä¾¿äºå®¢æˆ·å’Œå›¢é˜Ÿä¸æ‚¨æ²Ÿé€šã€‚</p>
                            
                            <form id="profileForm" class="space-y-5">
                                <div>
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest block mb-2">ğŸ“§ é‚®ç®± (Email)</label>
                                    <input type="email" id="profileEmail" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white focus:border-indigo-500 outline-none transition-all text-sm font-medium">
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                    <div>
                                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest block mb-2">ğŸ’¬ å¾®ä¿¡ (WeChat)</label>
                                        <input type="text" id="profileWechat" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white focus:border-indigo-500 outline-none transition-all text-sm font-medium">
                                    </div>
                                    <div>
                                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest block mb-2">ğŸ“± WhatsApp</label>
                                        <input type="text" id="profileWhatsapp" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white focus:border-indigo-500 outline-none transition-all text-sm font-medium">
                                    </div>
                                </div>

                                <div class="pt-4">
                                    <button type="submit" class="bg-slate-900 text-white px-8 py-3.5 rounded-xl font-bold shadow-lg hover:bg-indigo-600 transition-all text-sm">ğŸ’¾ ä¿å­˜è”ç³»æ–¹å¼</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-red-50/50 rounded-3xl p-8 border border-red-100 shadow-sm">
                            <h3 class="text-lg font-bold text-red-600 mb-2">è´¦å·ä¸å®‰å…¨</h3>
                            <p class="text-xs text-red-400 mb-6 leading-relaxed">ç®¡ç†æ‚¨çš„ç™»å½•çŠ¶æ€æˆ–æ°¸ä¹…æ³¨é”€ä¸šåŠ¡å‘˜è´¦æˆ·ã€‚</p>
                            
                            <div class="flex flex-col gap-3">
                                <button onclick="logout()" class="w-full py-3 bg-white border border-slate-200 text-slate-700 rounded-xl font-bold text-xs hover:bg-slate-50 hover:text-indigo-600 transition-all shadow-sm flex items-center justify-center gap-2 group">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 group-hover:stroke-indigo-600 transition-colors">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" />
                                    </svg>
                                    åˆ‡æ¢è´¦å· / ç™»å‡º
                                </button>
                                
                                <button onclick="showToast('è¯·è”ç³»ç®¡ç†å‘˜æ³¨é”€è´¦æˆ·')" class="w-full py-3 bg-white border border-red-200 text-red-600 rounded-xl font-bold text-xs hover:bg-red-50 hover:border-red-300 transition-all shadow-sm flex items-center justify-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                                    </svg>
                                    æ³¨é”€è´¦æˆ·
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <div id="toast" class="toast"></div>

    <script>
        // Supabase é…ç½®
        const SUPABASE_URL = 'https://xxouixhnhauvgrrchako.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4b3VpeGhuaGF1dmdycmNoYWtvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxNTk2NjYsImV4cCI6MjA4NTczNTY2Nn0.ph24qP9wXOAvsblwkobH9MhSrDFJ4g5vyGof7aUjjVw';
        
        // åˆå§‹åŒ– Supabaseï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
        let supabase = null;
        try {
            if (window.supabase && window.supabase.createClient) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase åˆå§‹åŒ–æˆåŠŸ');
            } else {
                console.error('Supabase åº“æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            }
        } catch (e) {
            console.error('Supabase åˆå§‹åŒ–å¤±è´¥:', e);
        }

        let currentUser = null;
        let currentRate = 7.05;

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkAuth() {
            const userData = localStorage.getItem('baisheng_user');
            if (!userData) {
                window.location.href = 'ç™»å½•.html';
                return null;
            }
            const user = JSON.parse(userData);
            const roles = Array.isArray(user.role) ? user.role : [user.role];
            if (!roles.includes('ä¸šåŠ¡å‘˜')) {
                showToast('æ— æƒè®¿é—®æ­¤é¡µé¢');
                setTimeout(() => window.location.href = 'ç™»å½•.html', 1500);
                return null;
            }
            return user;
        }

        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®å®šé€€å‡ºï¼Ÿ')) {
                localStorage.removeItem('baisheng_user');
                window.location.href = 'ç™»å½•.html';
            }
        }

        // Toast æç¤º
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // åŠ è½½æ•°æ®
        async function loadCurrentUser() {
            if (!supabase) {
                console.warn('Supabase æœªåˆå§‹åŒ–ï¼Œè·³è¿‡åŠ è½½ç”¨æˆ·æ•°æ®');
                return;
            }
            try {
                const userId = currentUser.user_id || currentUser.id;
                if (!userId) {
                    console.error('ç”¨æˆ·IDä¸å­˜åœ¨');
                    return;
                }
                
                const { data, error } = await supabase
                    .from('01_user_master')
                    .select('*')
                    .eq('user_id', userId)
                    .single();
                
                if (error) {
                    console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
                    return;
                }
                
                if (data) {
                    currentUser = { ...currentUser, ...data };
                    localStorage.setItem('baisheng_user', JSON.stringify(currentUser));
                }
            } catch (err) {
                console.error('åŠ è½½å½“å‰ç”¨æˆ·å¤±è´¥:', err);
            }
        }

        async function loadData() {
            try {
                await loadCurrentUser();
                await Promise.all([
                    loadExchangeRate(),
                    loadOverviewData(),
                    loadOrders(),
                    loadReferralStats(),
                    loadNotifications()
                ]);
                updateUserInfo();
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
                showToast('æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•');
            }
        }

        // åŠ è½½æ±‡ç‡
        async function loadExchangeRate() {
            if (!supabase) return;
            try {
                const { data, error } = await supabase
                    .from('08_exchange_rate')
                    .select('*')
                    .eq('from_currency', 'USD')
                    .eq('to_currency', 'CNY')
                    .order('updated_at', { ascending: false })
                    .limit(1);
                
                if (error) {
                    console.error('åŠ è½½æ±‡ç‡å¤±è´¥:', error);
                    return;
                }
                
                if (data && data.length > 0) {
                    currentRate = parseFloat(data[0].exec_rate) * 0.99; // å‡1%
                    document.getElementById('exchangeRate').textContent = `1 USD â‰ˆ Â¥${currentRate.toFixed(2)}`;
                }
            } catch (err) {
                console.error('åŠ è½½æ±‡ç‡å‡ºé”™:', err);
            }
        }

        // ============================================================
        // æ ¸å¿ƒé€»è¾‘ä¿®æ”¹ï¼šæŒ‰æœåŠ¡ç±»/é‡‡è´­ç±»åˆ†åˆ«ç»Ÿè®¡
        // ============================================================
        async function loadOverviewData() {
            if (!currentUser || !supabase) return;
            try {
                // 1. è·å–æœ¬æœˆç¬¬ä¸€å¤©å’Œæœ€åä¸€å¤©
                const now = new Date();
                const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
                const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0).toISOString();

                // 2. ä» 02_order_master æ‹‰å–æœ¬æœˆæ‰€æœ‰"å·²å®Œæˆ"è®¢å•
                const { data: orders, error } = await supabase
                    .from('02_order_master')
                    .select('biz_type, gross_profit, commission_salesman, status')
                    .eq('salesman_id', currentUser.user_id || currentUser.id)
                    .eq('status', 'å·²å®Œæˆ') 
                    .gte('updated_at', firstDay)
                    .lte('updated_at', lastDay);

                if (error) {
                    console.error('åŠ è½½ä¸šç»©æ•°æ®å¤±è´¥:', error);
                    return;
                }

                // 3. åˆ†ç±»å®šä¹‰ (æŒ‰æ‚¨çš„è¦æ±‚)
                // é‡‡è´­ç±»
                const procurementTypes = ['sourcing', 'dropshipping', 'group_buy'];
                // æœåŠ¡ç±» (æŠŠ tourist_purchase ç§»åˆ°äº†è¿™é‡Œ)
                const serviceTypes = ['tour_guide', 'medical_guide', 'digital_kit', 'airport_pickup', 'car_service', 'tourist_purchase'];

                // 4. è®¡ç®—ç»Ÿè®¡
                let procurementProfit = 0; // é‡‡è´­ç±»ç´¯è®¡æ¯›åˆ©
                let serviceProfit = 0;     // æœåŠ¡ç±»ç´¯è®¡æ¯›åˆ© (æ–°æŒ‡æ ‡)
                let serviceComm = 0;       // æœåŠ¡ç±»å®é™…ä½£é‡‘

                orders?.forEach(o => {
                    const profit = parseFloat(o.gross_profit) || 0;
                    const comm = parseFloat(o.commission_salesman) || 0;

                    if (procurementTypes.includes(o.biz_type)) {
                        procurementProfit += profit; // é‡‡è´­ç±»åªç´¯åŠ æ¯›åˆ©ï¼Œåé¢ç®—é˜¶æ¢¯
                    } else if (serviceTypes.includes(o.biz_type)) {
                        serviceProfit += profit;     // ç´¯åŠ æœåŠ¡ç±»æ¯›åˆ© (ç”¨äºå¡ç‰‡æ˜¾ç¤º)
                        serviceComm += comm;         // ç´¯åŠ æœåŠ¡ç±»ä½£é‡‘ (ç”¨äºç®—æ€»é’±)
                    }
                });

                // 5. æ‰§è¡Œé‡‡è´­ç±»"é˜¶æ¢¯ç®—æ³•" (å¤åˆ» SQL é€»è¾‘)
                let procurementComm = 0;
                let tier = '10%';
                let nextTierDiff = 0;
                let progress = 0;

                if (procurementProfit <= 10000) {
                    procurementComm = procurementProfit * 0.10;
                    tier = '10%';
                    nextTierDiff = 10000 - procurementProfit;
                    progress = (procurementProfit / 10000) * 100;
                } else {
                    // è¶…è¿‡1ä¸‡çš„éƒ¨åˆ†æŒ‰12%ç®—
                    procurementComm = 1000 + (procurementProfit - 10000) * 0.12;
                    tier = '12%';
                    nextTierDiff = 0; // å·²æ»¡çº§
                    progress = 100;
                }

                // 6. æ±‡æ€»æ€»ä½£é‡‘ (é‡‡è´­é˜¶æ¢¯ä½£é‡‘ + æœåŠ¡å®é™…ä½£é‡‘)
                const totalEstimatedComm = procurementComm + serviceComm;

                // 7. æ›´æ–° UI æ˜¾ç¤º
                
                // å¡ç‰‡1ï¼šæ€»ä½£é‡‘
                document.getElementById('monthCommission').textContent = `Â¥${totalEstimatedComm.toLocaleString('zh-CN', {minimumFractionDigits: 2})}`;
                
                // å¡ç‰‡2ï¼šé‡‡è´­ç±»æ¯›åˆ© & è¿›åº¦æ¡
                document.getElementById('totalProcurementProfit').textContent = `Â¥${Math.floor(procurementProfit).toLocaleString()}`;
                document.getElementById('commissionTier').textContent = `${tier} æ¡£ä½`;
                document.getElementById('commissionTier').className = `px-2 py-1 rounded text-[10px] font-bold ${tier === '12%' ? 'bg-purple-100 text-purple-700' : 'bg-indigo-50 text-indigo-600'}`;
                
                document.getElementById('nextTierInfo').textContent = nextTierDiff > 0 
                    ? `è·ç¦» 12% æ¡£ä½è¿˜å·®æ¯›åˆ© Â¥${nextTierDiff.toFixed(0)}` 
                    : 'ğŸ‰ å·²è¾¾åˆ°æœ€é«˜ 12% æ¡£ä½';
                    
                document.getElementById('tierProgress').style.width = `${Math.min(progress, 100)}%`;

                // å¡ç‰‡3ï¼šæœåŠ¡ç±»ç´¯è®¡æ¯›åˆ© (æ›¿æ¢äº†åŸæ¥çš„"èµ„è´¨åˆ—è¡¨")
                // æ³¨æ„ï¼šè¿™é‡Œæˆ‘ä»¬æ˜¾ç¤º"æœåŠ¡ç±»æ€»æ¯›åˆ©"ï¼Œè€Œä¸æ˜¯èµ„è´¨
                document.getElementById('totalServiceProfit').textContent = `Â¥${Math.floor(serviceProfit).toLocaleString()}`;

            } catch (err) {
                console.error('åŠ è½½ä¸šç»©æ€»è§ˆå‡ºé”™:', err);
            }
        }

        // åŠ è½½è®¢å•
        async function loadOrders() {
            if (!currentUser || !supabase) return;
            try {
                const { data: orders, error } = await supabase
                    .from('02_order_master')
                    .select('order_id, biz_type, currency, amount_fc, amount_cny, status, updated_at, order_info')
                    .eq('salesman_id', currentUser.user_id || currentUser.id)
                    .order('updated_at', { ascending: false });
                
                if (error) {
                    console.error('åŠ è½½è®¢å•å¤±è´¥:', error);
                    return;
                }
                
                const tbody = document.getElementById('ordersTableBody');
                if (!orders || orders.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-slate-400">æš‚æ— è®¢å•æ•°æ®</td></tr>`;
                    return;
                }
                
                tbody.innerHTML = orders.map(order => {
                    const statusColors = {
                        'è¿›è¡Œä¸­': 'bg-blue-50 text-blue-600',
                        'å·²å®Œæˆ': 'bg-green-50 text-green-600',
                        'å·²å–æ¶ˆ': 'bg-slate-100 text-slate-500',
                        'å·²ç»“ç®—': 'bg-purple-50 text-purple-600'
                    };
                
                    const statusClass = statusColors[order.status] || 'bg-slate-50 text-slate-600';
                    const orderDate = order.updated_at ? new Date(order.updated_at).toLocaleDateString('zh-CN') : '-';
                    
                    return `
                        <tr class="border-b border-slate-50 hover:bg-slate-50/50 transition-all">
                            <td class="p-5 pl-8">
                                <div class="font-mono text-xs font-bold">${order.order_id || '-'}</div>
                                <div class="text-[10px] text-slate-400 mt-0.5">${orderDate}</div>
                            </td>
                            <td class="p-5">
                                <div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-indigo-500"></span>${order.biz_type || 'Sourcing'}</div>
                            </td>
                            <td class="p-5 text-right text-slate-500 font-mono text-xs">${order.currency || 'USD'} ${parseFloat(order.amount_fc || 0).toLocaleString()}</td>
                            <td class="p-5 text-right text-slate-500 font-mono text-xs">Â¥${parseFloat(order.amount_cny || 0).toLocaleString()}</td>
                            <td class="p-5 pr-8 text-right"><span class="px-3 py-1 ${statusClass} rounded-lg text-[10px] font-black uppercase tracking-wider">${order.status}</span></td>
                        </tr>
                    `;
                }).join('');
            } catch (err) {
                console.error('åŠ è½½è®¢å•å‡ºé”™:', err);
                document.getElementById('ordersTableBody').innerHTML = `<tr><td colspan="6" class="p-8 text-center text-red-400">åŠ è½½å¤±è´¥</td></tr>`;
            }
        }

        // åŠ è½½æ¨èç»Ÿè®¡
        // æ¨èä¸­å¿ƒé€»è¾‘ï¼šæ ¸å¿ƒä¿®å¤è¿æ¥ referrer_id
        async function loadReferralStats() {
            if (!currentUser || !supabase) return;
            const uid = currentUser.user_id || currentUser.id;
            document.getElementById('myReferralCode').textContent = currentUser.referral_code || 'BS8A2D';

            try {
                // 1. è·å–æ‹›å‹Ÿå®¢æˆ·åˆ—è¡¨ (é€šè¿‡ referrer_id å…³è” 01 è¡¨)
                const { data: recs } = await supabase
                    .from('01_user_master')
                    .select('real_name, created_at, first_service_at')
                    .eq('referrer_id', uid)
                    .order('created_at', { ascending: false });

                document.getElementById('recruitCount').textContent = `${recs?.length || 0} ä½`;
                document.getElementById('recruitListBody').innerHTML = recs?.map(r => `
                    <tr class="border-b border-slate-50 hover:bg-slate-50 transition-colors">
                        <td class="px-6 py-4 font-bold text-slate-700">${mask(r.real_name)}</td>
                        <td class="px-6 py-4 text-xs text-slate-400 font-mono">${r.created_at.slice(0, 10)}</td>
                        <td class="px-6 py-4 text-right">${r.first_service_at ? '<span class="text-green-500 font-bold">âœ… å·²æˆå•</span>' : '<span class="text-slate-300">â³ å¾…è½¬åŒ–</span>'}</td>
                    </tr>`).join('') || '<tr><td colspan="3" class="p-8 text-center text-slate-400">æš‚æ— æ‹›å‹Ÿè®°å½•</td></tr>';

                // 2. è·å–å¥–åŠ±æ˜ç»† (å…³è” 05 è¡¨)
                const { data: pays } = await supabase
                    .from('05_referral_details')
                    .select('*')
                    .eq('referrer_id', uid)
                    .order('settle_month', { ascending: false });

                let tSpend = 0, tPay = 0;
                pays?.forEach(p => { 
                    tSpend += parseFloat(p.amount_cny || 0); 
                    tPay += parseFloat(p.payout || 0); 
                });

                document.getElementById('refTotalPayout').textContent = `Â¥${tPay.toLocaleString('zh-CN', {minimumFractionDigits: 2})}`;
                document.getElementById('refProgSum').textContent = `ç´¯è®¡æ¨èæ¶ˆè´¹: Â¥${tSpend.toLocaleString()}`;
                document.getElementById('payoutListBody').innerHTML = pays?.map(p => `
                    <tr class="border-b border-slate-50 hover:bg-slate-50 transition-colors">
                        <td class="px-6 py-4 text-xs font-mono text-slate-500">${p.order_id.slice(0, 8)}...</td>
                        <td class="px-6 py-4 text-xs font-bold text-indigo-600 text-center">${(parseFloat(p.rate)*100).toFixed(1)}%</td>
                        <td class="px-6 py-4 text-right font-black text-green-600">Â¥${parseFloat(p.payout).toFixed(2)}</td>
                    </tr>`).join('') || '<tr><td colspan="3" class="p-8 text-center text-slate-400">æš‚æ— å¥–åŠ±å‘æ”¾è®°å½•</td></tr>';

                // 3. è®¡ç®—å¹¶æ›´æ–°ç­‰çº§è¿›åº¦æ¡
                updateRefTierUI(tSpend);
            } catch (err) { console.error('æ¨èä¸­å¿ƒåŠ è½½å¤±è´¥:', err); }
        }

        // ç­‰çº§è¿›åº¦æ¡é€»è¾‘
        function updateRefTierUI(spend) {
            let rate = "2%", prog = 0, next = "";
            if (spend < 20000) { rate = "2%"; prog = (spend/20000)*25; next = `è· 3% è¿˜å·® Â¥${(20000-spend).toFixed(0)}`; }
            else if (spend < 100000) { rate = "3%"; prog = 25+((spend-20000)/80000)*25; next = `è· 4% è¿˜å·® Â¥${(100000-spend).toFixed(0)}`; }
            else if (spend < 500000) { rate = "4%"; prog = 50+((spend-100000)/400000)*25; next = `è· 5% è¿˜å·® Â¥${(500000-spend).toFixed(0)}`; }
            else { rate = "5%"; prog = 100; next = "ğŸ‰ å·²è¾¾æœ€é«˜ææˆç­‰çº§"; }
            
            document.getElementById('refRateDisplay').textContent = rate;
            document.getElementById('refProgressBar').style.width = `${prog}%`;
            document.getElementById('refNextLabel').textContent = next;
        }

        // è¾…åŠ©ï¼šè„±æ•å‡½æ•°
        function mask(n) { if(!n) return '--'; return n.length <= 2 ? n[0]+'*' : n[0]+'**'+n.slice(-1); }

        // åŠ è½½é€šçŸ¥
        async function loadNotifications() {
            try {
                const notifList = document.getElementById('notificationList');
                if (!notifList) return;
                
                notifList.innerHTML = `
                    <div class="p-4 border-b border-slate-50 hover:bg-slate-50 cursor-pointer transition-colors">
                        <div class="flex items-start gap-3">
                            <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-600 shrink-0 text-lg">ğŸ’°</div>
                            <div>
                                <p class="text-xs font-bold text-slate-800">é¢„ä¼°ä½£é‡‘å·²é‡æ–°è®¡ç®—</p>
                                <p class="text-[10px] text-slate-500 mt-1 leading-relaxed">æ‚¨çš„è®¢å•è´¢åŠ¡å·²å½•å…¥æˆæœ¬ï¼Œé¢„ä¼°ä½£é‡‘å·²æ›´æ–°ã€‚</p>
                                <p class="text-[9px] text-slate-400 mt-2">åˆšåˆš</p>
                            </div>
                        </div>
                    </div>
                `;
            } catch (err) {
                console.error('åŠ è½½é€šçŸ¥å‡ºé”™:', err);
            }
        }


        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
        function updateUserInfo() {
            if (!currentUser) return;
            const displayName = currentUser.real_name || currentUser.name || 'ä¸šåŠ¡å‘˜';
            const userId = currentUser.user_id || currentUser.id || 'USER-0000';
            
            document.getElementById('userName').textContent = displayName;
            document.getElementById('userId').textContent = `ID: ${userId}`;
            document.getElementById('userAvatar').textContent = displayName.substring(0, 2).toUpperCase();
            document.getElementById('profileName').textContent = displayName;
            document.getElementById('profileId').textContent = `å®¢æˆ·ç¼–å·ï¼š${userId}`;
            document.getElementById('profilePhone').textContent = `æ‰‹æœºï¼š${currentUser.phone || 'N/A'}`;
            document.getElementById('profileAvatar').textContent = displayName.substring(0, 2).toUpperCase();
            document.getElementById('profileEmail').value = currentUser.email || '';
            document.getElementById('profileWechat').value = currentUser.wechat || '';
            document.getElementById('profileWhatsapp').value = currentUser.whatsapp || '';
        }

        // Tab åˆ‡æ¢
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-indigo-50', 'text-indigo-600', 'font-bold');
                el.classList.add('text-slate-500', 'font-medium');
            });
            const activeNav = document.getElementById('nav-' + tabId);
            if (activeNav) {
                activeNav.classList.remove('text-slate-500', 'font-medium');
                activeNav.classList.add('bg-indigo-50', 'text-indigo-600', 'font-bold');
            }

            const titles = {
                'overview': 'ä¸šç»©æ€»è§ˆ',
                'orders': 'è®¢å•æ˜ç»† (å«æˆæœ¬)',
                'referral': 'å‘å±•å®¢æˆ·ä¸æ¨èæ ‘',
                'profile': 'ä¸ªäººä¸­å¿ƒä¸å®‰å…¨è®¾ç½®'
            };
            document.getElementById('page-title').innerText = titles[tabId] || 'ä¸šåŠ¡ç³»ç»Ÿ';
        }

        // ============================================================
        // æ¨¡æ‹Ÿå™¨ä¹ŸåŒæ­¥ V5 æ ‡å‡†
        // ============================================================
        function calculateCommission() {
            const amount = parseFloat(document.getElementById('sim-amount').value);
            const currency = document.getElementById('sim-currency').value;
            const type = document.getElementById('sim-type').value;

            if (!amount || amount <= 0) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„å¤–å¸é‡‘é¢ï¼');
                return;
            }
            
            const rates = { 'USD': 7.05, 'EUR': 7.72, 'GBP': 9.10, 'AUD': 4.60, 'CAD': 5.20, 'SGD': 5.30, 'CHF': 8.20, 'JPY': 0.048, 'HKD': 0.91, 'NZD': 4.30 };
            const rate = rates[currency] || 7.05;
            const rmbRevenue = amount * rate;
            
            let commission = 0;
            let calcDetail = '';

            if (type === 'sourcing') {
                const estimatedProfit = rmbRevenue * 0.20; 
                commission = estimatedProfit * 0.10; 
                calcDetail = `å‡è®¾20%æ¯›åˆ© (Â¥${estimatedProfit.toFixed(0)}) Ã— 10% èµ·æ­¥æ¡£ä½`;
            } else {
                commission = rmbRevenue * 0.40;
                calcDetail = `æœåŠ¡ç±»ç›´æï¼šè¥æ”¶ (Â¥${rmbRevenue.toFixed(0)}) Ã— 40% æ¯”ä¾‹`;
            }
            
            const resultDiv = document.getElementById('sim-result');
            resultDiv.innerHTML = `
                <div class="p-5 bg-indigo-800/40 rounded-2xl border border-indigo-500/30 text-sm animate-pulse-once">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-indigo-200">æŠ˜åˆäººæ°‘å¸:</span> 
                        <strong class="text-white text-lg">Â¥${rmbRevenue.toFixed(2)}</strong>
                    </div>
                    <div class="flex justify-between items-center mb-3">
                        <span class="text-indigo-200">è®¡ç®—è¯´æ˜:</span> 
                        <span class="text-indigo-300 text-xs text-right">${calcDetail}</span>
                    </div>
                    <div class="flex justify-between items-center pt-3 border-t border-indigo-500/30">
                        <span class="text-green-400 font-bold">é¢„ä¼°åˆ°æ‰‹ä½£é‡‘:</span> 
                        <span class="text-green-400 font-black text-2xl">Â¥${commission.toFixed(2)}</span>
                    </div>
                </div>
            `;
            resultDiv.classList.remove('hidden');
        }

        function copyReferralLink() {
            const code = currentUser?.referral_code || 'BS8A2D';
            const link = `${window.location.origin}/æ³¨å†Œ.html?ref=${code}`;
            navigator.clipboard.writeText(link).then(() => showToast('é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿'));
        }

        function toggleNotifications() {
            const panel = document.getElementById('notification-panel');
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                setTimeout(() => {
                    panel.classList.remove('opacity-0', 'scale-95');
                    panel.classList.add('opacity-100', 'scale-100');
                }, 10);
            } else {
                panel.classList.remove('opacity-100', 'scale-100');
                panel.classList.add('opacity-0', 'scale-95');
                setTimeout(() => panel.classList.add('hidden'), 200);
            }
        }

        function markAllRead() {
            document.getElementById('unread-dot').style.display = 'none';
        }

        document.getElementById('profileForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            if (!supabase) {
                showToast('ç³»ç»Ÿæœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                return;
            }
            try {
                const email = document.getElementById('profileEmail').value;
                const wechat = document.getElementById('profileWechat').value;
                const whatsapp = document.getElementById('profileWhatsapp').value;
                const updateData = {};
                if (email && email.trim()) updateData.email = email.trim(); else if (email === '') updateData.email = null;
                if (wechat && wechat.trim()) updateData.wechat = wechat.trim(); else if (wechat === '') updateData.wechat = null;
                if (whatsapp && whatsapp.trim()) updateData.whatsapp = whatsapp.trim(); else if (whatsapp === '') updateData.whatsapp = null;
                
                const { error } = await supabase
                    .from('01_user_master')
                    .update(updateData)
                    .eq('user_id', currentUser.user_id);
                if (error) throw error;
                await loadCurrentUser();
                updateUserInfo();
                showToast('è”ç³»æ–¹å¼å·²æ›´æ–°');
            } catch (error) {
                showToast('ä¿å­˜å¤±è´¥ï¼š' + error.message);
            }
        });

        window.addEventListener('DOMContentLoaded', async () => {
            try {
                currentUser = checkAuth();
                if (!currentUser) {
                    document.getElementById('loadingOverlay').style.display = 'none';
                    return;
                }
                
                if (!supabase) {
                    console.error('Supabase æœªåˆå§‹åŒ–ï¼Œæ— æ³•åŠ è½½æ•°æ®');
                    showToast('ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                    updateUserInfo();
                    document.getElementById('loadingOverlay').style.display = 'none';
                    return;
                }
                
                await loadData();
                document.getElementById('loadingOverlay').style.display = 'none';
            } catch (err) {
                console.error('é¡µé¢åˆå§‹åŒ–å¤±è´¥:', err);
                showToast('é¡µé¢åŠ è½½å¤±è´¥: ' + err.message);
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        });

        document.addEventListener('click', function(event) {
            const container = document.getElementById('notification-container');
            const panel = document.getElementById('notification-panel');
            if (container && panel && !container.contains(event.target) && !panel.classList.contains('hidden')) {
                toggleNotifications();
            }
        });
    </script>
</body>
</html>
