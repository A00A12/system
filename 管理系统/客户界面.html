<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¢æˆ·çœ‹æ¿ | æŸç››å…¨çƒåˆä¼™äººç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.8/dist/umd/supabase.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .vip-gradient-1 { background: linear-gradient(135deg, #1e40af 0%, #3b82f6 100%); }
        .vip-gradient-2 { background: linear-gradient(135deg, #0f172a 0%, #334155 100%); }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .service-selected {
            border-color: #2563eb !important;
            background-color: #eff6ff !important;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1);
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid #e2e8f0;
            border-top-color: #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        .toast.show { transform: translateX(0); }
        .toast.error { background: #ef4444; }
        .toast.success { background: #22c55e; }
    </style>
</head>
<body class="text-slate-900 antialiased h-screen flex overflow-hidden">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <aside class="w-64 bg-white border-r border-slate-100 hidden md:flex flex-col justify-between h-full z-30 relative shadow-sm">
        <div>
            <div class="h-20 flex items-center px-8 border-b border-slate-50">
                <span class="text-xl font-black text-blue-600 tracking-tight">æŸç››ç³»ç»Ÿ <span class="text-xs text-slate-400 font-medium">v5.0</span></span>
            </div>
            <nav class="p-4 space-y-2 mt-4" id="nav-menu">
                <button onclick="switchTab('overview')" id="nav-overview" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-blue-50 text-blue-600 font-bold transition-all">
                    <span class="text-lg">ğŸ“Š</span> æ€»è§ˆçœ‹æ¿
                </button>
                <button onclick="switchTab('order')" id="nav-order" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 hover:text-slate-900 font-medium transition-all">
                    <span class="text-lg">ğŸ›’</span> æœåŠ¡ä¸‹å•
                </button>
                <button onclick="switchTab('history')" id="nav-history" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 hover:text-slate-900 font-medium transition-all">
                    <span class="text-lg">ğŸ“œ</span> æ¶ˆè´¹è®°å½•
                </button>
                <button onclick="switchTab('referral')" id="nav-referral" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 hover:text-slate-900 font-medium transition-all">
                    <span class="text-lg">ğŸ¤</span> æˆ‘çš„æ¨è
                </button>

                <div class="pt-4 mt-4 border-t border-slate-100"></div>
                <button onclick="switchTab('profile')" id="nav-profile" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 hover:text-slate-900 font-medium transition-all">
                    <span class="text-lg">ğŸ‘¤</span> ä¸ªäººä¸­å¿ƒ
                </button>
                <button onclick="logout()" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-red-50 hover:text-red-600 font-medium transition-all">
                    <span class="text-lg">ğŸšª</span> é€€å‡ºç™»å½•
                </button>
            </nav>
        </div>
        <div class="p-4 border-t border-slate-50">
            <div onclick="switchTab('profile')" class="flex items-center gap-3 px-4 py-3 rounded-xl bg-slate-50 cursor-pointer hover:bg-slate-100 transition-all">
                <div class="w-10 h-10 rounded-full bg-blue-200 flex items-center justify-center font-bold text-blue-700" id="userAvatar">--</div>
                <div class="text-left">
                    <div class="text-sm font-bold text-slate-800" id="userName">åŠ è½½ä¸­...</div>
                    <div class="text-[10px] text-slate-500 uppercase tracking-wider" id="userId">--</div>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 h-full overflow-y-auto relative bg-[#f8fafc]">

        <header class="h-20 bg-white/80 backdrop-blur-md border-b border-slate-100 flex items-center justify-between px-8 sticky top-0 z-20">
            <h1 class="text-xl font-extrabold text-slate-800" id="page-title">æ¬¢è¿å›æ¥</h1>

            <div class="flex items-center gap-4">
                <button onclick="refreshData()" class="px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                    <span id="refreshIcon">ğŸ”„</span> åˆ·æ–°æ•°æ®
                </button>
                <div class="relative" id="notification-container">
                    <button onclick="toggleNotifications()" class="w-10 h-10 rounded-full bg-slate-50 flex items-center justify-center text-xl hover:bg-slate-100 transition-all relative">
                        ğŸ””
                        <span id="unread-dot" class="absolute top-2 right-2 w-2 h-2 bg-red-500 rounded-full border border-white animate-pulse hidden"></span>
                    </button>

                    <div id="notification-panel" class="hidden absolute right-0 mt-3 w-80 bg-white rounded-2xl shadow-2xl border border-slate-100 overflow-hidden z-50 transform opacity-0 scale-95 transition-all duration-200 origin-top-right">
                        <div class="p-4 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
                            <h3 class="font-bold text-slate-800 text-sm">ç³»ç»Ÿé€šçŸ¥</h3>
                            <button onclick="markAllRead()" class="text-[10px] font-bold text-blue-600 hover:text-blue-800">å…¨éƒ¨æ ‡ä¸ºå·²è¯»</button>
                        </div>
                        <div id="notificationList" class="max-h-80 overflow-y-auto">
                            <div class="p-4 text-center text-slate-400 text-sm">æš‚æ— é€šçŸ¥</div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="p-8 max-w-7xl mx-auto">

            <div id="tab-overview" class="tab-content active space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="vip-gradient-1 rounded-3xl p-6 text-white shadow-lg shadow-blue-500/20 relative overflow-hidden group">
                        <div class="absolute -right-6 -top-6 w-32 h-32 bg-white/10 rounded-full blur-2xl group-hover:scale-110 transition-transform"></div>
                        <div class="flex justify-between items-start mb-8 relative z-10">
                            <div>
                                <p class="text-[10px] font-bold uppercase tracking-widest text-blue-200 mb-1">Purchasing VIP</p>
                                <h3 class="text-2xl font-black" id="purchaseVipLevel">VIP 1</h3>
                            </div>
                            <div class="px-3 py-1 bg-white/20 rounded-full text-xs font-bold backdrop-blur-sm border border-white/10" id="purchaseDiscount">æœåŠ¡è´¹ï¼š10%</div>
                        </div>
                        <div class="relative z-10">
                            <div class="flex justify-between text-xs font-medium text-blue-100 mb-2">
                                <span id="purchaseSpent">ç´¯è®¡æ¶ˆè´¹: Â¥0</span>
                                <span id="purchaseToNext">è· VIP2 å·® Â¥10,000</span>
                            </div>
                            <div class="w-full h-2 bg-blue-900/50 rounded-full overflow-hidden">
                                <div class="h-full bg-white rounded-full" id="purchaseProgress" style="width: 0%"></div>
                            </div>
                            <p class="text-[10px] mt-3 text-blue-200" id="purchaseNextBenefit">è¾¾æ ‡åæœåŠ¡è´¹é™è‡³ 8%</p>
                        </div>
                    </div>
                    <div class="vip-gradient-2 rounded-3xl p-6 text-white shadow-lg shadow-slate-900/20 relative overflow-hidden group">
                        <div class="absolute -right-6 -top-6 w-32 h-32 bg-white/10 rounded-full blur-2xl group-hover:scale-110 transition-transform"></div>
                        <div class="flex justify-between items-start mb-8 relative z-10">
                            <div>
                                <p class="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-1">Service VIP</p>
                                <h3 class="text-2xl font-black" id="serviceVipLevel">VIP 1</h3>
                            </div>
                            <div class="px-3 py-1 bg-white/10 rounded-full text-xs font-bold backdrop-blur-sm border border-white/10" id="serviceDiscount">ä¸“å±æŠ˜æ‰£ï¼šæ— </div>
                        </div>
                        <div class="relative z-10">
                            <div class="flex justify-between text-xs font-medium text-slate-300 mb-2">
                                <span id="serviceSpent">ç´¯è®¡æ¶ˆè´¹: Â¥0</span>
                                <span id="serviceToNext">è· VIP2 å·® Â¥5,000</span>
                            </div>
                            <div class="w-full h-2 bg-slate-800 rounded-full overflow-hidden">
                                <div class="h-full bg-blue-400 rounded-full" id="serviceProgress" style="width: 0%"></div>
                            </div>
                            <p class="text-[10px] mt-3 text-slate-400" id="serviceNextBenefit">è¾¾æ ‡åäº« 95æŠ˜ ä¼˜æƒ </p>
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-3xl p-8 border border-blue-100 flex flex-col md:flex-row items-center justify-between gap-6 shadow-sm">
                    <div>
                        <h3 class="text-xl font-extrabold text-slate-800 mb-2">é‚€è¯·å¥½å‹ï¼Œèµšå–è¢«åŠ¨æ”¶å…¥</h3>
                        <p class="text-sm text-slate-500 font-medium">æœ€é«˜å¯äº«è¢«æ¨èäººæ¶ˆè´¹é¢ 5% ææˆã€‚</p>
                    </div>
                    <div class="flex items-center gap-4 bg-white p-2 pl-6 rounded-2xl border border-white shadow-sm">
                        <span class="font-mono font-black text-blue-600 text-xl tracking-[0.2em]" id="referralCode">------</span>
                        <button onclick="switchTab('referral')" class="px-6 py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 transition-all shadow-md shadow-blue-200">
                            æŸ¥çœ‹æˆ‘çš„æ¨è
                        </button>
                    </div>
                </div>
            </div>

            <div id="tab-order" class="tab-content space-y-8">
                <div class="bg-white rounded-3xl p-8 border border-slate-100 shadow-sm">
                    <h2 class="text-2xl font-black text-slate-800 mb-2">é€‰æ‹©ä¸šåŠ¡ç±»å‹</h2>
                    <p class="text-slate-500 text-sm mb-8">æ”¯æŒ 9 ç§è·¨å¢ƒåŠæœ¬åœ°åŒ–æœåŠ¡ï¼Œæ±‡ç‡å®æ—¶è®¡ç®—ã€‚</p>

                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4">
                        <div id="card-digital_kit" onclick="selectService('digital_kit', 'æ•°å­—åŒ–ç”Ÿå­˜è®¾å¤‡ (Digital Kit)')" class="service-card service-selected p-5 rounded-2xl border-2 border-slate-100 hover:border-blue-200 hover:bg-slate-50 cursor-pointer text-center transition-all bg-white">
                            <div class="text-3xl mb-2">ğŸ’»</div>
                            <h3 class="font-bold text-slate-800 text-sm">æ•°å­—åŒ–ç”Ÿå­˜</h3>
                            <p class="text-[9px] text-slate-500 mt-1 uppercase">Digital Kit</p>
                        </div>
                        <div id="card-sourcing" onclick="selectService('sourcing', 'å…¨çƒé‡‡è´­ (Sourcing)')" class="service-card p-5 rounded-2xl border-2 border-slate-100 hover:border-blue-200 hover:bg-slate-50 cursor-pointer text-center transition-all bg-white">
                            <div class="text-3xl mb-2">ğŸ“¦</div>
                            <h3 class="font-bold text-slate-800 text-sm">å…¨çƒé‡‡è´­</h3>
                            <p class="text-[9px] text-slate-500 mt-1 uppercase">Sourcing</p>
                        </div>
                        <div id="card-dropshipping" onclick="selectService('dropshipping', 'ä¸€ä»¶ä»£å‘ (Dropshipping)')" class="service-card p-5 rounded-2xl border-2 border-slate-100 hover:border-blue-200 hover:bg-slate-50 cursor-pointer text-center transition-all bg-white">
                            <div class="text-3xl mb-2">ğŸšš</div>
                            <h3 class="font-bold text-slate-800 text-sm">ä¸€ä»¶ä»£å‘</h3>
                            <p class="text-[9px] text-slate-500 mt-1 uppercase">Dropshipping</p>
                        </div>
                        <div id="card-group_buy" onclick="selectService('group_buy', 'æ‹¼é‚®å›¢è´­ (Group Buy)')" class="service-card p-5 rounded-2xl border-2 border-slate-100 hover:border-blue-200 hover:bg-slate-50 cursor-pointer text-center transition-all bg-white">
                            <div class="text-3xl mb-2">ğŸ›’</div>
                            <h3 class="font-bold text-slate-800 text-sm">æ‹¼é‚®å›¢è´­</h3>
                            <p class="text-[9px] text-slate-500 mt-1 uppercase">Group Buy</p>
                        </div>
                        <div id="card-tourist_purchase" onclick="selectService('tourist_purchase', 'æ¸¸å®¢ä»£è´­ (Tourist Purchase)')" class="service-card p-5 rounded-2xl border-2 border-slate-100 hover:border-blue-200 hover:bg-slate-50 cursor-pointer text-center transition-all bg-white">
                            <div class="text-3xl mb-2">ğŸ›ï¸</div>
                            <h3 class="font-bold text-slate-800 text-sm">æ¸¸å®¢ä»£è´­</h3>
                            <p class="text-[9px] text-slate-500 mt-1 uppercase">Tourist Purchase</p>
                        </div>
                        <div id="card-airport_pickup" onclick="selectService('airport_pickup', 'æœºåœºä¸“è½¦æ¥é€ (Airport Pickup)')" class="service-card p-5 rounded-2xl border-2 border-slate-100 hover:border-blue-200 hover:bg-slate-50 cursor-pointer text-center transition-all bg-white">
                            <div class="text-3xl mb-2">âœˆï¸</div>
                            <h3 class="font-bold text-slate-800 text-sm">æœºåœºæ¥é€</h3>
                            <p class="text-[9px] text-slate-500 mt-1 uppercase">Airport</p>
                        </div>
                        <div id="card-car_service" onclick="selectService('car_service', 'ä¸“å±ç”¨è½¦æœåŠ¡ (Car Service)')" class="service-card p-5 rounded-2xl border-2 border-slate-100 hover:border-blue-200 hover:bg-slate-50 cursor-pointer text-center transition-all bg-white">
                            <div class="text-3xl mb-2">ğŸš—</div>
                            <h3 class="font-bold text-slate-800 text-sm">ç”¨è½¦æœåŠ¡</h3>
                            <p class="text-[9px] text-slate-500 mt-1 uppercase">Car Service</p>
                        </div>
                        <div id="card-tour_guide" onclick="selectService('tour_guide', 'æ—…æ¸¸åœ°é™ªåŒ (Tour Guide)')" class="service-card p-5 rounded-2xl border-2 border-slate-100 hover:border-blue-200 hover:bg-slate-50 cursor-pointer text-center transition-all bg-white">
                            <div class="text-3xl mb-2">ğŸ—ºï¸</div>
                            <h3 class="font-bold text-slate-800 text-sm">æ—…æ¸¸åœ°é™ªåŒ</h3>
                            <p class="text-[9px] text-slate-500 mt-1 uppercase">Tour Guide</p>
                        </div>
                        <div id="card-medical_guide" onclick="selectService('medical_guide', 'åŒ»ç–—é™ªåŒ (Medical Guide)')" class="service-card p-5 rounded-2xl border-2 border-slate-100 hover:border-blue-200 hover:bg-slate-50 cursor-pointer text-center transition-all bg-white">
                            <div class="text-3xl mb-2">ğŸ¥</div>
                            <h3 class="font-bold text-slate-800 text-sm">åŒ»ç–—é™ªåŒ</h3>
                            <p class="text-[9px] text-slate-500 mt-1 uppercase">Medical Guide</p>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-900 rounded-3xl p-8 text-white relative overflow-hidden transition-all duration-300 shadow-xl">
                    <div class="absolute top-0 right-0 w-64 h-64 bg-blue-500/20 rounded-full blur-3xl -mr-20 -mt-20"></div>
                    <h3 class="text-xl font-bold mb-6 relative z-10" id="form-service-title">å¿«é€Ÿé…ç½®ï¼šæ•°å­—åŒ–ç”Ÿå­˜è®¾å¤‡ (Digital Kit)</h3>

                    <form id="orderForm" class="relative z-10 grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-widest">ç»“ç®—å¸ç§</label>
                            <select id="currency" class="w-full px-4 py-4 rounded-xl bg-white/10 border border-white/20 text-white outline-none focus:border-blue-500 transition-all">
                                <option class="text-slate-900" value="USD">USD - ç¾å…ƒ</option>
                                <option class="text-slate-900" value="EUR">EUR - æ¬§å…ƒ</option>
                                <option class="text-slate-900" value="CNY">CNY - äººæ°‘å¸</option>
                            </select>
                        </div>

                        <div class="space-y-2">
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-widest">è®¢å•é‡‘é¢</label>
                            <input type="number" id="orderAmount" step="0.01" placeholder="è¯·è¾“å…¥é‡‘é¢"
                                class="w-full px-4 py-4 rounded-xl bg-white/10 border border-white/20 text-white outline-none focus:border-blue-500 transition-all">
                        </div>

                        <div class="space-y-2 md:col-span-2">
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-widest">è®¢å•è¯¦æƒ…æè¿°</label>
                            <textarea id="orderDesc" rows="3" placeholder="è¯·æè¿°æ‚¨çš„éœ€æ±‚..."
                                class="w-full px-4 py-4 rounded-xl bg-white/10 border border-white/20 text-white outline-none focus:border-blue-500 transition-all"></textarea>
                        </div>

                        <div class="md:col-span-2 mt-4">
                            <button type="submit" id="submitOrderBtn" class="px-8 py-4 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-500 transition-all shadow-lg shadow-blue-500/30 flex items-center gap-2">
                                <span>ç¡®è®¤ç”Ÿæˆè®¢å•</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div id="tab-history" class="tab-content space-y-6">
                <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
                    <div class="p-6 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
                        <h3 class="text-lg font-extrabold text-slate-800">æ‰€æœ‰å†å²è®¢å•</h3>
                        <div class="relative">
                            <input type="text" id="orderSearch" placeholder="æœç´¢è®¢å•ç¼–å·..."
                                class="pl-10 pr-4 py-2 bg-white border border-slate-200 rounded-lg text-sm outline-none focus:border-blue-500 transition-all">
                            <span class="absolute left-3 top-2.5 text-slate-400">ğŸ”</span>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="bg-white border-b border-slate-100 text-[10px] uppercase tracking-widest text-slate-400 font-bold">
                                    <th class="p-5 pl-8 font-medium">è®¢å•ç¼–å·</th>
                                    <th class="p-5 font-medium">ä¸šåŠ¡ç±»å‹</th>
                                    <th class="p-5 font-medium">å¤‡æ³¨</th>
                                    <th class="p-5 font-medium text-right">å¤–å¸é‡‘é¢</th>
                                    <th class="p-5 font-medium text-right">æŠ˜åˆäººæ°‘å¸</th>
                                    <th class="p-5 pr-8 font-medium text-right">çŠ¶æ€</th>
                                </tr>
                            </thead>
                            <tbody id="orderHistoryList" class="text-sm font-medium text-slate-700">
                                <tr><td colspan="6" class="p-8 text-center text-slate-400">åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-referral" class="tab-content space-y-6">
                <div class="bg-gradient-to-br from-blue-600 to-indigo-700 rounded-3xl p-8 text-white shadow-xl flex flex-col md:flex-row items-center justify-between gap-8">
                    <div class="space-y-4">
                        <span class="px-3 py-1 bg-white/20 rounded-full text-[10px] font-bold tracking-widest uppercase">My Invite Code</span>
                        <h2 class="text-5xl font-mono font-black tracking-[0.2em] drop-shadow-md" id="displayReferralCode">------</h2>
                        <p class="text-blue-100 text-sm max-w-md leading-relaxed">
                            å½“æ‚¨çš„æœ‹å‹ä½¿ç”¨æ­¤ä¸“å±æ¨èç æ³¨å†Œï¼Œä»–ä»¬å°†è‡ªåŠ¨ç»‘å®šä¸ºæ‚¨çš„ 1çº§ä¸‹çº§ã€‚
                        </p>
                        <button onclick="copyReferralCode()" class="mt-4 px-6 py-3 bg-white text-blue-700 rounded-xl font-bold shadow-lg hover:bg-blue-50 transition-all">
                            å¤åˆ¶æ¨èç 
                        </button>
                    </div>
                    <div class="w-32 h-32 bg-white rounded-2xl p-2 shadow-inner shrink-0 flex items-center justify-center">
                        <div class="text-center text-slate-400 text-xs">
                            <div class="text-4xl mb-1">ğŸ‘¥</div>
                            <div>æ¨è</div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-3xl border border-slate-100 shadow-sm p-8">
                    <div class="flex justify-between items-end mb-6">
                        <div>
                            <h3 class="text-xl font-bold text-slate-800">æ¨èæ˜ç»†</h3>
                            <p class="text-xs text-slate-400 mt-1">ç³»ç»Ÿæ¯å‘¨ä¸€è‡ªåŠ¨ç»“ç®—å®¢æˆ·æ¨èææˆã€‚</p>
                        </div>
                        <div class="text-right">
                            <span class="block text-[10px] text-slate-400 font-bold uppercase tracking-widest mb-1">ç´¯è®¡ææˆæ”¶ç›Š</span>
                            <span class="text-3xl font-black text-green-500" id="totalCommission">Â¥0.00</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                            <span class="block text-xs text-slate-500 font-bold">æ¨èè®¢å•æ•°</span>
                            <span class="text-2xl font-black text-slate-800" id="referralCount">0 <span class="text-sm font-medium text-slate-400">ç¬”</span></span>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                            <span class="block text-xs text-slate-500 font-bold">æ¨èè®¢å•é‡‘é¢</span>
                            <span class="text-2xl font-black text-slate-800" id="referralSpending">Â¥0</span>
                        </div>
                        <div class="p-4 bg-slate-50 rounded-2xl border border-slate-100">
                            <span class="block text-xs text-slate-500 font-bold">ç´¯è®¡ææˆæ”¶ç›Š</span>
                            <span class="text-2xl font-black text-green-600" id="totalCommissionSmall">Â¥0</span>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead>
                                <tr class="border-b border-slate-100 text-[10px] uppercase tracking-widest text-slate-400 font-bold">
                                    <th class="p-4">è¢«æ¨èäºº</th>
                                    <th class="p-4 text-right">æ¶ˆè´¹é‡‘é¢</th>
                                    <th class="p-4 text-right">ææˆ</th>
                                    <th class="p-4 text-right">ææˆæ¯”ä¾‹</th>
                                </tr>
                            </thead>
                            <tbody id="referralList">
                                <tr><td colspan="4" class="p-4 text-center text-slate-400">åŠ è½½ä¸­...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-profile" class="tab-content space-y-6">
                <div class="bg-white rounded-3xl p-8 border border-slate-100 shadow-sm flex flex-col md:flex-row items-center gap-8">
                    <div class="w-24 h-24 rounded-full bg-blue-100 flex items-center justify-center text-4xl font-black text-blue-600 shrink-0" id="profileAvatar">
                        --
                    </div>
                    <div class="flex-1 text-center md:text-left">
                        <h2 class="text-2xl font-extrabold text-slate-800 mb-1" id="profileName">--</h2>
                        <p class="text-sm font-bold text-slate-500 mb-4">ç³»ç»Ÿè§’è‰²ï¼š<span class="text-blue-600">å®¢æˆ·</span></p>
                        <div class="flex flex-wrap gap-4 justify-center md:justify-start">
                            <span class="px-3 py-1 bg-slate-50 border border-slate-200 rounded-lg text-xs font-bold text-slate-600" id="profilePhone">æ‰‹æœºï¼š--</span>
                            <span class="px-3 py-1 bg-slate-50 border border-slate-200 rounded-lg text-xs font-bold text-slate-600" id="profileId">å®¢æˆ·ç¼–å·ï¼š--</span>
                        </div>
                        <div class="mt-2 text-xs text-slate-400 font-mono" id="debugUserId"></div>
                    </div>
                </div>

                <div class="bg-white rounded-3xl p-8 border border-slate-100 shadow-sm relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-indigo-50 rounded-bl-full -z-0"></div>

                    <h3 class="text-xl font-bold text-slate-800 mb-2 relative z-10">è”ç³»æ–¹å¼ä¸è´¦å·ç»‘å®š</h3>
                    <p class="text-sm text-slate-500 mb-8 relative z-10">å®Œå–„ä»¥ä¸‹ä¿¡æ¯ä»¥ä¾¿åœ¨å¿˜è®°å¯†ç æ—¶è¿›è¡Œæ‰¾å›ã€‚</p>

                    <form id="profileForm" class="relative z-10 max-w-2xl space-y-6">
                        <div class="space-y-2">
                            <label class="block text-xs font-bold text-slate-700 uppercase tracking-widest">å”¯ä¸€éªŒè¯é‚®ç®± (Email) <span class="text-red-500">*</span></label>
                            <div class="relative">
                                <div class="absolute inset-y-0 left-0 flex items-center pl-4 pointer-events-none text-slate-400">âœ‰ï¸</div>
                                <input type="email" id="bindEmail" required placeholder="ä¾‹å¦‚: admin@pt5global.com"
                                    class="w-full pl-12 pr-4 py-4 rounded-2xl bg-slate-50 border border-slate-200 focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition-all text-slate-900 font-medium">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="space-y-2">
                                <label class="block text-xs font-bold text-slate-700 uppercase tracking-widest">å¾®ä¿¡ (WeChat)</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 flex items-center pl-4 pointer-events-none text-slate-400">ğŸ’¬</div>
                                    <input type="text" id="bindWechat" placeholder="è¯·è¾“å…¥å¾®ä¿¡å·"
                                        class="w-full pl-12 pr-4 py-4 rounded-2xl bg-slate-50 border border-slate-200 focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition-all text-slate-900 font-medium">
                                </div>
                            </div>

                            <div class="space-y-2">
                                <label class="block text-xs font-bold text-slate-700 uppercase tracking-widest">WhatsApp</label>
                                <div class="relative">
                                    <div class="absolute inset-y-0 left-0 flex items-center pl-4 pointer-events-none text-slate-400">ğŸ“</div>
                                    <input type="text" id="bindWhatsapp" placeholder="å¸¦å›½å®¶åŒºå·ï¼Œå¦‚ +65..."
                                        class="w-full pl-12 pr-4 py-4 rounded-2xl bg-slate-50 border border-slate-200 focus:bg-white focus:border-blue-500 focus:ring-4 focus:ring-blue-500/10 outline-none transition-all text-slate-900 font-medium">
                                </div>
                            </div>
                        </div>

                        <div class="pt-4">
                            <button type="submit" id="saveProfileBtn" class="px-8 py-4 bg-slate-900 text-white rounded-xl font-bold hover:bg-blue-600 transition-all shadow-lg shadow-slate-200 flex items-center gap-2">
                                <span>ğŸ’¾ ä¿å­˜å¹¶åŒæ­¥è‡³æ•°æ®åº“</span>
                            </button>
                        </div>
                    </form>
                </div>

            </div>

        </div>
    </main>

    <script>
        // Supabase é…ç½®
        const SUPABASE_URL = 'https://xxouixhnhauvgrrchako.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4b3VpeGhuaGF1dmdycmNoYWtvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxNTk2NjYsImV4cCI6MjA4NTczNTY2Nn0.ph24qP9wXOAvsblwkobH9MhSrDFJ4g5vyGof7aUjjVw';

        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        let currentService = 'digital_kit';
        let exchangeRate = 7.05;

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        function checkAuth() {
            const userData = localStorage.getItem('baisheng_user');
            if (!userData) {
                window.location.href = 'ç™»å½•.html';
                return null;
            }
            const user = JSON.parse(userData);
            // role å¯èƒ½æ˜¯æ•°ç»„æˆ–å­—ç¬¦ä¸²
            const roles = Array.isArray(user.role) ? user.role : [user.role];
            if (!roles.includes('å®¢æˆ·')) {
                showToast('æ— æƒè®¿é—®æ­¤é¡µé¢', 'error');
                setTimeout(() => {
                    window.location.href = 'ç™»å½•.html';
                }, 1500);
                return null;
            }
            return user;
        }

        // æ˜¾ç¤º Toast
        function showToast(message, type = 'error') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ä»æ•°æ®åº“é‡æ–°åŠ è½½å½“å‰ç”¨æˆ·æ•°æ®
        async function loadCurrentUser() {
            try {
                const userId = currentUser?.user_id || currentUser?.id;
                if (!userId) return;

                const { data, error } = await supabase
                    .from('01_user_master')
                    .select('*')
                    .eq('user_id', userId)
                    .single();

                if (error || !data) return;

                // æ›´æ–° currentUser å¯¹è±¡
                currentUser = { ...currentUser, ...data };
                localStorage.setItem('baisheng_user', JSON.stringify(currentUser));
            } catch (err) {
                console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', err);
            }
        }

        // åŠ è½½ç”¨æˆ·æ•°æ®
        async function loadUserData() {
            if (!currentUser) {
                console.error('currentUser ä¸ºç©º');
                return;
            }

            try {
                // è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯
                const { data: userData, error: userError } = await supabase
                    .from('01_user_master')
                    .select('*')
                    .eq('user_id', currentUser.user_id)
                    .single();

                if (userError) {
                    console.error('æŸ¥è¯¢ç”¨æˆ·è¯¦æƒ…å¤±è´¥:', userError);
                    throw userError;
                }

                // æ›´æ–°ç”¨æˆ·æ˜¾ç¤ºä¿¡æ¯
                document.getElementById('userName').textContent = userData.real_name || 'å®¢æˆ·';
                document.getElementById('userId').textContent = 'ID: ' + userData.user_id;
                document.getElementById('userAvatar').textContent = (userData.real_name || 'å®¢').substring(0, 2);
                document.getElementById('page-title').textContent = 'æ¬¢è¿å›æ¥ï¼Œ' + (userData.real_name || 'å®¢æˆ·');

                // æ›´æ–°ä¸ªäººèµ„æ–™é¡µ
                document.getElementById('profileName').textContent = userData.real_name || 'å®¢æˆ·';
                document.getElementById('profileAvatar').textContent = (userData.real_name || 'å®¢').substring(0, 2);
                document.getElementById('profilePhone').textContent = 'æ‰‹æœºï¼š' + (userData.phone || '--');
                document.getElementById('profileId').textContent = 'å®¢æˆ·ç¼–å·ï¼š' + userData.user_id;
                document.getElementById('referralCode').textContent = userData.user_id.substring(0, 6) || '------';
                document.getElementById('displayReferralCode').textContent = userData.user_id.substring(0, 6) || '------';

                // ç»‘å®šè¡¨å•æ•°æ® - ä»æ•°æ®åº“åŠ è½½
                document.getElementById('bindEmail').value = userData.email || '';
                document.getElementById('bindWechat').value = userData.wechat || '';
                document.getElementById('bindWhatsapp').value = userData.whatsapp || '';
                
                // æ›´æ–° currentUser å¯¹è±¡
                currentUser.email = userData.email || null;
                currentUser.wechat = userData.wechat || null;
                currentUser.whatsapp = userData.whatsapp || null;

                // æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯
                document.getElementById('debugUserId').textContent = 'UserID: ' + userData.user_id;

                // æ›´æ–° VIP ç­‰çº§æ˜¾ç¤º
                await updateVipDisplay(userData);

                // åŠ è½½è®¢å•å†å²
                await loadOrderHistory(userData.user_id);

                // åŠ è½½æ¨èæ•°æ®
                await loadReferralData(userData.user_id);

            } catch (err) {
                console.error('åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:', err);
                showToast('åŠ è½½æ•°æ®å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•');
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        }

        // æ›´æ–°VIPæ˜¾ç¤º
        // ä»02_order_masterè¡¨è®¡ç®—VIPæ¶ˆè´¹é‡‘é¢
        async function calculateVipSpending(userId) {
            try {
                console.log('è®¡ç®—VIPæ¶ˆè´¹ï¼Œç”¨æˆ·ID:', userId);
                
                // é‡‡è´­ç±»biz_type: dropshipping, sourcing, groupbuy
                const purchaseTypes = ['dropshipping', 'sourcing', 'groupbuy'];
                // æœåŠ¡ç±»biz_type: digital_kit, touristpurchase, airport pick, car service, tourguide, medical guide
                const serviceTypes = ['digital_kit', 'touristpurchase', 'airport pick', 'car service', 'tourguide', 'medical guide'];
                
                // è·å–æ‰€æœ‰å·²å®Œæˆ/è¿›è¡Œä¸­çš„è®¢å•
                const { data: orders, error } = await supabase
                    .from('02_order_master')
                    .select('biz_type, amount_fc, amount_cny, currency, status')
                    .eq('customer_id', userId)
                    .in('status', ['å·²å®Œæˆ', 'è¿›è¡Œä¸­']);
                
                if (error) {
                    console.error('æŸ¥è¯¢VIPæ¶ˆè´¹æ•°æ®å¤±è´¥:', error);
                    return { purchaseSpent: 0, serviceSpent: 0, purchaseCurrency: 'USD' };
                }
                
                console.log('VIPè®¡ç®— - æŸ¥è¯¢åˆ°çš„è®¢å•:', orders);
                
                let purchaseSpent = 0;
                let serviceSpent = 0;
                let purchaseCurrency = 'USD'; // é»˜è®¤å¸ç§
                
                if (orders) {
                    orders.forEach(order => {
                        const bizType = order.biz_type || '';
                        
                        if (purchaseTypes.includes(bizType)) {
                            // é‡‡è´­ç±»VIPè¯»å–amount_fcï¼ˆå¤–å¸é‡‘é¢ï¼‰
                            const amount = parseFloat(order.amount_fc) || 0;
                            purchaseSpent += amount;
                            // è®°å½•å¸ç§ï¼ˆå–ç¬¬ä¸€ä¸ªè®¢å•çš„å¸ç§ï¼‰
                            if (order.currency && purchaseCurrency === 'USD') {
                                purchaseCurrency = order.currency;
                            }
                            console.log('é‡‡è´­ç±»è®¢å•:', { bizType, amount_fc: amount, currency: order.currency });
                        } else if (serviceTypes.includes(bizType)) {
                            // æœåŠ¡ç±»VIPè¯»å–amount_cnyï¼ˆäººæ°‘å¸é‡‘é¢ï¼‰
                            const amount = parseFloat(order.amount_cny) || 0;
                            serviceSpent += amount;
                            console.log('æœåŠ¡ç±»è®¢å•:', { bizType, amount_cny: amount });
                        } else {
                            console.log('æœªåŒ¹é…ç±»å‹:', bizType);
                        }
                    });
                }
                
                console.log('VIPè®¡ç®—ç»“æœ:', { purchaseSpent, serviceSpent, purchaseCurrency });
                return { purchaseSpent, serviceSpent, purchaseCurrency };
            } catch (err) {
                console.error('è®¡ç®—VIPæ¶ˆè´¹å¤±è´¥:', err);
                return { purchaseSpent: 0, serviceSpent: 0, purchaseCurrency: 'USD' };
            }
        }
        
        // è®¡ç®—VIPç­‰çº§
        function calculateVipLevel(spent, thresholds) {
            let level = 1;
            for (let i = thresholds.length - 1; i >= 0; i--) {
                if (spent >= thresholds[i]) {
                    level = i + 1;
                    break;
                }
            }
            return level;
        }

        // æ›´æ–°VIPæ˜¾ç¤º
        async function updateVipDisplay(userData) {
            const userId = userData.user_id || currentUser?.user_id;
            const { purchaseSpent, serviceSpent, purchaseCurrency } = await calculateVipSpending(userId);
            
            // VIPç­‰çº§é˜ˆå€¼
            const purchaseThresholds = [0, 10000, 50000, 100000, 500000];
            const serviceThresholds = [0, 5000, 20000, 50000, 100000];
            
            // è®¡ç®—VIPç­‰çº§
            const purchaseVip = calculateVipLevel(purchaseSpent, purchaseThresholds);
            const serviceVip = calculateVipLevel(serviceSpent, serviceThresholds);

            document.getElementById('purchaseVipLevel').textContent = 'VIP ' + purchaseVip;
            document.getElementById('serviceVipLevel').textContent = 'VIP ' + serviceVip;

            // é‡‡è´­ç±» VIP è¿›åº¦ - æ˜¾ç¤ºå¤–å¸é‡‘é¢
            document.getElementById('purchaseSpent').textContent = 'ç´¯è®¡æ¶ˆè´¹: ' + purchaseCurrency + ' ' + purchaseSpent.toLocaleString();
            let nextPurchaseThreshold = purchaseThresholds[purchaseVip] || 1000000;
            let purchaseProgress = Math.min(100, (purchaseSpent / nextPurchaseThreshold) * 100);
            document.getElementById('purchaseProgress').style.width = purchaseProgress + '%';
            document.getElementById('purchaseToNext').textContent = 'è· VIP' + (purchaseVip + 1) + ' å·® ' + purchaseCurrency + ' ' + Math.max(0, nextPurchaseThreshold - purchaseSpent).toLocaleString();

            // æœåŠ¡ç±» VIP è¿›åº¦ - æ˜¾ç¤ºäººæ°‘å¸é‡‘é¢
            document.getElementById('serviceSpent').textContent = 'ç´¯è®¡æ¶ˆè´¹: Â¥' + serviceSpent.toLocaleString();
            let nextServiceThreshold = serviceThresholds[serviceVip] || 200000;
            let serviceProgress = Math.min(100, (serviceSpent / nextServiceThreshold) * 100);
            document.getElementById('serviceProgress').style.width = serviceProgress + '%';
            document.getElementById('serviceToNext').textContent = 'è· VIP' + (serviceVip + 1) + ' å·® Â¥' + Math.max(0, nextServiceThreshold - serviceSpent).toLocaleString();
        }

        // åŠ è½½è®¢å•å†å²
        async function loadOrderHistory(userId) {
            try {
                console.log('åŠ è½½è®¢å•å†å²ï¼Œç”¨æˆ·ID:', userId);

                // ç›´æ¥ä»02_order_masterè¡¨æŸ¥è¯¢å½“å‰ç”¨æˆ·çš„è®¢å•
                const { data: orders, error } = await supabase
                    .from('02_order_master')
                    .select('order_id, biz_type, currency, amount_fc, amount_cny, status, order_info, updated_at')
                    .eq('customer_id', userId)
                    .order('updated_at', { ascending: false });

                if (error) {
                    console.error('æŸ¥è¯¢è®¢å•é”™è¯¯:', error);
                    throw error;
                }

                console.log('æŸ¥è¯¢åˆ°çš„è®¢å•:', orders);

                const tbody = document.getElementById('orderHistoryList');
                if (!orders || orders.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" class="p-8 text-center text-slate-400">æš‚æ— è®¢å•è®°å½•</td></tr>';
                    return;
                }

                tbody.innerHTML = orders.map(order => {
                    const statusColors = {
                        'è¿›è¡Œä¸­': 'bg-blue-50 text-blue-600',
                        'å·²å®Œæˆ': 'bg-green-50 text-green-600',
                        'å·²å–æ¶ˆ': 'bg-red-50 text-red-600',
                        'å·²ç»“ç®—': 'bg-purple-50 text-purple-600'
                    };
                    const statusClass = statusColors[order.status] || 'bg-slate-50 text-slate-600';
                    
                    // ä¸šåŠ¡ç±»å‹ä¸­æ–‡æ˜ å°„
                    const bizTypeMap = {
                        'dropshipping': 'Dropshipping',
                        'sourcing': 'Sourcing',
                        'groupbuy': 'å›¢è´­',
                        'digital_kit': 'Digital Kit',
                        'touristpurchase': 'æ—…æ¸¸ä»£è´­',
                        'airport pick': 'æœºåœºæ¥é€',
                        'car service': 'ç”¨è½¦æœåŠ¡',
                        'tourguide': 'å¯¼æ¸¸æœåŠ¡',
                        'medical guide': 'åŒ»ç–—å‘å¯¼'
                    };
                    
                    const bizType = bizTypeMap[order.biz_type] || order.biz_type || 'æ™®é€šè®¢å•';
                    const amountFc = parseFloat(order.amount_fc) || 0;
                    const amountCny = parseFloat(order.amount_cny) || 0;

                    return `
                        <tr class="border-b border-slate-50 hover:bg-slate-50/50 transition-colors">
                            <td class="p-5 pl-8 font-mono text-xs text-slate-500">${order.order_id}</td>
                            <td class="p-5"><div class="flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-blue-500"></span>${bizType}</div></td>
                            <td class="p-5 text-slate-500 text-xs">${order.order_info || '-'}</td>
                            <td class="p-5 text-right font-bold text-slate-900">${order.currency || 'USD'} ${amountFc.toLocaleString()}</td>
                            <td class="p-5 text-right text-slate-500 text-xs">Â¥${amountCny.toLocaleString()}</td>
                            <td class="p-5 pr-8 text-right"><span class="px-3 py-1 ${statusClass} rounded-lg text-[10px] font-black uppercase tracking-wider">${order.status}</span></td>
                        </tr>
                    `;
                }).join('');

            } catch (err) {
                console.error('åŠ è½½è®¢å•å†å²å¤±è´¥:', err);
                document.getElementById('orderHistoryList').innerHTML = `<tr><td colspan="6" class="p-8 text-center text-red-400">åŠ è½½å¤±è´¥: ${err.message || 'æœªçŸ¥é”™è¯¯'}<br><small class="text-slate-400">è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜</small></td></tr>`;
            }
        }

        // åŠ è½½æ¨èæ•°æ® - ä»05_referral_detailsè¡¨è¯»å–
        async function loadReferralData(userId) {
            try {
                console.log('åŠ è½½æ¨èæ•°æ®ï¼Œç”¨æˆ·ID:', userId);

                // ä»05_referral_detailsè¡¨æŸ¥è¯¢å½“å‰ç”¨æˆ·çš„æ¨èè®°å½•
                const { data: referrals, error } = await supabase
                    .from('05_referral_details')
                    .select('id, order_id, amount_cny, rate, payout, settle_month')
                    .eq('referrer_id', userId)
                    .order('settle_month', { ascending: false });

                if (error) {
                    console.error('æŸ¥è¯¢æ¨èæ•°æ®å¤±è´¥:', error);
                    document.getElementById('referralList').innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-400">åŠ è½½å¤±è´¥: ${error.message}</td></tr>`;
                    return;
                }

                console.log('æ¨èæ•°æ®:', referrals);

                // è·å–å…³è”çš„è®¢å•ä¿¡æ¯ï¼ˆè¢«æ¨èäººï¼‰
                let enrichedReferrals = [];
                if (referrals && referrals.length > 0) {
                    const orderIds = referrals.map(r => r.order_id);
                    const { data: orders } = await supabase
                        .from('02_order_master')
                        .select('order_id, customer_id, order_info')
                        .in('order_id', orderIds);

                    // è·å–å®¢æˆ·ä¿¡æ¯
                    const customerIds = orders?.map(o => o.customer_id) || [];
                    const { data: customers } = await supabase
                        .from('01_user_master')
                        .select('user_id, real_name')
                        .in('user_id', customerIds);

                    // åˆå¹¶æ•°æ®
                    enrichedReferrals = referrals.map(ref => {
                        const order = orders?.find(o => o.order_id === ref.order_id);
                        const customer = customers?.find(c => c.user_id === order?.customer_id);
                        return {
                            ...ref,
                            referred_name: customer?.real_name || 'æœªçŸ¥ç”¨æˆ·',
                            order_info: order?.order_info || '-'
                        };
                    });
                }

                // ç»Ÿè®¡
                const referralCount = referrals ? referrals.length : 0;
                let totalSpending = 0;
                let totalCommission = 0;

                if (referrals && referrals.length > 0) {
                    referrals.forEach(r => {
                        totalSpending += parseFloat(r.amount_cny) || 0;
                        totalCommission += parseFloat(r.payout) || 0;
                    });
                }

                // æ›´æ–°ç»Ÿè®¡å¡ç‰‡
                document.getElementById('referralCount').innerHTML = referralCount + ' <span class="text-sm font-medium text-slate-400">ç¬”</span>';
                document.getElementById('referralSpending').textContent = 'Â¥' + totalSpending.toLocaleString();
                document.getElementById('totalCommission').textContent = 'Â¥' + totalCommission.toLocaleString();
                document.getElementById('totalCommissionSmall').textContent = 'Â¥' + totalCommission.toLocaleString();

                // æ¸²æŸ“åˆ—è¡¨
                const tbody = document.getElementById('referralList');
                if (!enrichedReferrals || enrichedReferrals.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-400">æš‚æ— æ¨èè®°å½•</td></tr>';
                    return;
                }

                tbody.innerHTML = enrichedReferrals.map(r => {
                    const amount = parseFloat(r.amount_cny) || 0;
                    const payout = parseFloat(r.payout) || 0;
                    const rate = parseFloat(r.rate) || 0;
                    return `
                        <tr class="border-b border-slate-50">
                            <td class="p-4">
                                <div class="font-medium">${r.referred_name}</div>
                                <div class="text-xs text-slate-400">${r.order_info || '-'}</div>
                            </td>
                            <td class="p-4 text-right">Â¥${amount.toLocaleString()}</td>
                            <td class="p-4 text-right text-green-600">Â¥${payout.toLocaleString()}</td>
                            <td class="p-4 text-right text-xs text-slate-400">${(rate * 100).toFixed(1)}%</td>
                        </tr>
                    `;
                }).join('');

            } catch (err) {
                console.error('åŠ è½½æ¨èæ•°æ®å¤±è´¥:', err);
                document.getElementById('referralList').innerHTML = `<tr><td colspan="4" class="p-4 text-center text-red-400">åŠ è½½å¤±è´¥: ${err.message || 'æœªçŸ¥é”™è¯¯'}</td></tr>`;
            }
        }

        // é€‰æ‹©æœåŠ¡
        function selectService(serviceId, serviceName) {
            currentService = serviceId;
            document.querySelectorAll('.service-card').forEach(card => {
                card.classList.remove('service-selected');
            });
            document.getElementById('card-' + serviceId).classList.add('service-selected');
            document.getElementById('form-service-title').textContent = 'å¿«é€Ÿé…ç½®ï¼š' + serviceName;
        }

        // æäº¤è®¢å•
        document.getElementById('orderForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const btn = document.getElementById('submitOrderBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> æäº¤ä¸­...';

            try {
                const currency = document.getElementById('currency').value;
                const amount = parseFloat(document.getElementById('orderAmount').value);
                const desc = document.getElementById('orderDesc').value;

                if (!amount || amount <= 0) {
                    showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„è®¢å•é‡‘é¢');
                    return;
                }

                // ç”ŸæˆUUIDæ ¼å¼çš„è®¢å•å·
                function generateUUID() {
                    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                    });
                }
                const orderId = generateUUID();

                // è®¡ç®—äººæ°‘å¸é‡‘é¢
                const rates = { 'USD': 7.05, 'EUR': 7.72, 'CNY': 1 };
                const execRate = rates[currency] || 7.05;
                const amountCny = amount * execRate;

                console.log('æäº¤è®¢å•:', { orderId, currentService, currentUser: currentUser?.user_id, currency, amount, desc });

                const { error } = await supabase
                    .from('02_order_master')
                    .insert([{
                        order_id: orderId,
                        biz_type: currentService,
                        customer_id: currentUser.user_id,
                        salesman_id: null,
                        currency: currency,
                        amount_fc: amount,
                        exec_rate: execRate,
                        amount_cny: amountCny,
                        cost_product: 0,
                        cost_logistics: 0,
                        cost_tax_pack: 0,
                        cost_other: 0,
                        total_cost: 0,
                        status: 'è¿›è¡Œä¸­',
                        order_info: desc || null
                    }]);

                if (error) {
                    console.error('æ•°æ®åº“æ’å…¥é”™è¯¯:', error);
                    throw error;
                }

                showToast('è®¢å•æäº¤æˆåŠŸï¼', 'success');

                // æ¸…ç©ºè¡¨å•
                document.getElementById('orderAmount').value = '';
                document.getElementById('orderDesc').value = '';

                // åˆ·æ–°è®¢å•å†å²
                await loadOrderHistory(currentUser.user_id);

                // åˆ‡æ¢åˆ°å†å²è®°å½•é¡µ
                switchTab('history');

            } catch (err) {
                console.error('æäº¤è®¢å•å¤±è´¥:', err);
                showToast('æäº¤è®¢å•å¤±è´¥: ' + (err.message || 'è¯·é‡è¯•'), 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>ç¡®è®¤ç”Ÿæˆè®¢å•</span>';
            }
        });

        // ä¿å­˜ä¸ªäººèµ„æ–™
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const btn = document.getElementById('saveProfileBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="loading"></span> ä¿å­˜ä¸­...';

            try {
                // è·å–è¡¨å•æ•°æ®
                const email = document.getElementById('bindEmail').value.trim();
                const wechat = document.getElementById('bindWechat').value.trim();
                const whatsapp = document.getElementById('bindWhatsapp').value.trim();
                
                const userId = currentUser.user_id || currentUser.id;
                if (!userId) {
                    showToast('ç”¨æˆ·æœªç™»å½•ï¼Œè¯·é‡æ–°ç™»å½•', 'error');
                    btn.disabled = false;
                    btn.innerHTML = '<span>ğŸ’¾ ä¿å­˜å¹¶åŒæ­¥è‡³æ•°æ®åº“</span>';
                    return;
                }

                // æ„å»ºæ›´æ–°æ•°æ® - ç©ºå­—ç¬¦ä¸²è½¬ä¸º null
                const updateData = {
                    email: email || null,
                    wechat: wechat || null,
                    whatsapp: whatsapp || null
                };

                console.log('ä¿å­˜åˆ°æ•°æ®åº“:', updateData, 'ç”¨æˆ·ID:', userId);

                // æ›´æ–°æ•°æ®åº“
                const { data, error } = await supabase
                    .from('01_user_master')
                    .update(updateData)
                    .eq('user_id', userId)
                    .select();

                if (error) {
                    console.error('æ•°æ®åº“æ›´æ–°å¤±è´¥:', error);
                    showToast('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
                    btn.disabled = false;
                    btn.innerHTML = '<span>ğŸ’¾ ä¿å­˜å¹¶åŒæ­¥è‡³æ•°æ®åº“</span>';
                    return;
                }

                console.log('æ•°æ®åº“è¿”å›:', data);

                // ä¿å­˜åˆ° localStorage
                localStorage.setItem('baisheng_user_extra_' + userId, JSON.stringify({
                    email: email,
                    wechat: wechat,
                    whatsapp: whatsapp
                }));

                // æ›´æ–° currentUser
                currentUser.email = email || null;
                currentUser.wechat = wechat || null;
                currentUser.whatsapp = whatsapp || null;
                localStorage.setItem('baisheng_user', JSON.stringify(currentUser));

                showToast('èµ„æ–™å·²ä¿å­˜åˆ°æ•°æ®åº“ï¼', 'success');

            } catch (err) {
                console.error('ä¿å­˜å¤±è´¥:', err);
                showToast('ä¿å­˜å¤±è´¥: ' + (err.message || 'æœªçŸ¥é”™è¯¯'), 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>ğŸ’¾ ä¿å­˜å¹¶åŒæ­¥è‡³æ•°æ®åº“</span>';
            }
        });

        // åŠ è½½æœ¬åœ°å­˜å‚¨çš„é¢å¤–ä¿¡æ¯
        // å¤åˆ¶æ¨èç 
        function copyReferralCode() {
            const code = document.getElementById('displayReferralCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                showToast('æ¨èç å·²å¤åˆ¶ï¼', 'success');
            });
        }

        // åˆ·æ–°æ•°æ®
        async function refreshData() {
            const icon = document.getElementById('refreshIcon');
            icon.style.animation = 'spin 1s linear infinite';
            await loadUserData();
            setTimeout(() => {
                icon.style.animation = '';
            }, 1000);
            showToast('æ•°æ®å·²åˆ·æ–°', 'success');
        }

        // å·¦ä¾§å¯¼èˆªæ åˆ‡æ¢é€»è¾‘
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('tab-' + tabId).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('bg-blue-50', 'text-blue-600', 'font-bold');
                item.classList.add('text-slate-500', 'font-medium');
            });

            const activeNav = document.getElementById('nav-' + tabId);
            if (activeNav) {
                activeNav.classList.remove('text-slate-500', 'font-medium');
                activeNav.classList.add('bg-blue-50', 'text-blue-600', 'font-bold');
            }

            const titles = {
                'overview': 'æ¬¢è¿å›æ¥ï¼Œ' + (currentUser?.real_name || 'å®¢æˆ·'),
                'order': 'å‘èµ·æ–°ä¸šåŠ¡',
                'history': 'æˆ‘çš„æ¶ˆè´¹è®°å½•',
                'referral': 'æ¨èä¸è¿”ä½£ä¸­å¿ƒ',
                'profile': 'ä¸ªäººä¸­å¿ƒä¸è´¦å·è®¾ç½®'
            };
            document.getElementById('page-title').innerText = titles[tabId] || 'æŸç››ç³»ç»Ÿ';
        }

        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                localStorage.removeItem('baisheng_user');
                window.location.href = 'ç™»å½•.html';
            }
        }

        // é€šçŸ¥ç›¸å…³å‡½æ•°
        function toggleNotifications() {
            const panel = document.getElementById('notification-panel');
            if (panel.classList.contains('hidden')) {
                panel.classList.remove('hidden');
                setTimeout(() => {
                    panel.classList.remove('opacity-0', 'scale-95');
                    panel.classList.add('opacity-100', 'scale-100');
                }, 10);
            } else {
                panel.classList.remove('opacity-100', 'scale-100');
                panel.classList.add('opacity-0', 'scale-95');
                setTimeout(() => panel.classList.add('hidden'), 200);
            }
        }

        function markAllRead() {
            document.getElementById('unread-dot').classList.add('hidden');
        }

        document.addEventListener('click', function(event) {
            const container = document.getElementById('notification-container');
            const panel = document.getElementById('notification-panel');
            if (container && !container.contains(event.target) && !panel.classList.contains('hidden')) {
                toggleNotifications();
            }
        });

        // é¡µé¢åŠ è½½
        const loadingTimeout = setTimeout(() => {
            console.warn('é¡µé¢åŠ è½½è¶…æ—¶ï¼Œå¼ºåˆ¶éšè—åŠ è½½é®ç½©');
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) overlay.style.display = 'none';
        }, 15000);

        window.addEventListener('DOMContentLoaded', async () => {
            try {
                currentUser = checkAuth();
                if (!currentUser) {
                    clearTimeout(loadingTimeout);
                    document.getElementById('loadingOverlay').style.display = 'none';
                    return;
                }
                await loadUserData();
                clearTimeout(loadingTimeout);
            } catch (err) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', err);
                clearTimeout(loadingTimeout);
                document.getElementById('loadingOverlay').style.display = 'none';
            }
        });
    </script>
</body>
</html>