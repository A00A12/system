<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è´¢åŠ¡å·¥ä½œå° v5.7 | æŸç››å…¨çƒåˆä¼™äºº</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.8/dist/umd/supabase.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .finance-gradient { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(241, 245, 249, 1); }
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: #10b981; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .cost-input { 
            width: 100%; background: #fff; border: 1px solid #cbd5e1; border-radius: 6px; padding: 6px 8px; 
            font-size: 12px; text-align: right; font-family: 'Menlo', monospace; outline: none; transition: all 0.2s; 
        }
        .cost-input:focus { border-color: #10b981; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }
        .cost-input-readonly { background: #f8fafc; border-color: transparent; color: #64748b; cursor: default; }
    </style>
</head>
<body class="text-slate-900 h-screen flex overflow-hidden">

    <div id="loadingOverlay" class="loading-overlay"><div class="spinner"></div></div>

    <aside class="w-64 bg-white border-r border-slate-100 hidden md:flex flex-col justify-between h-full z-30 shadow-sm">
        <div>
            <div class="h-20 flex items-center px-8 border-b border-slate-50">
                <span class="text-xl font-black text-emerald-600 tracking-tight">æŸç››è´¢åŠ¡ <span class="text-xs text-slate-400 font-medium">v5.7</span></span>
            </div>
            <nav class="p-4 space-y-2 mt-4">
                <button onclick="switchTab('overview')" id="nav-overview" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-emerald-50 text-emerald-700 font-bold transition-all">
                    <span>ğŸ“Š</span> è´¢åŠ¡æ€»è§ˆ
                </button>
                <button onclick="switchTab('costs')" id="nav-costs" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 font-medium transition-all">
                    <span>ğŸ’°</span> æˆæœ¬ä¸ç»“ç®—
                </button>
                <button onclick="switchTab('compensations')" id="nav-compensations" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 font-medium transition-all">
                    <span>ğŸ“±</span> èµ”å¿å®¡æ ¸
                </button>
                <button onclick="switchTab('withdrawals')" id="nav-withdrawals" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 font-medium transition-all">
                    <span>ğŸ¦</span> èµ„é‡‘å‘æ”¾
                </button>
                <button onclick="switchTab('exchange')" id="nav-exchange" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 font-medium transition-all">
                    <span>ğŸ“ˆ</span> æ±‡ç‡ç®¡ç†
                </button>
                <div class="pt-4 mt-4 border-t border-slate-100"></div>
                <button onclick="switchTab('profile')" id="nav-profile" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 font-medium transition-all">
                    <span>ğŸ‘¤</span> ä¸ªäººä¸­å¿ƒ
                </button>
            </nav>
        </div>
        <div class="p-4 border-t border-slate-50">
            <div onclick="switchTab('profile')" class="flex items-center gap-3 px-4 py-3 rounded-xl bg-slate-50 cursor-pointer hover:bg-slate-100 transition-all">
                <div id="user-avatar" class="w-10 h-10 rounded-full bg-emerald-100 flex items-center justify-center font-bold text-emerald-700">FI</div>
                <div>
                    <div id="user-name" class="text-sm font-bold text-slate-800">CFO Office</div>
                    <div id="user-id" class="text-[10px] text-slate-500">ID: FIN-001</div>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 h-full overflow-y-auto bg-[#f8fafc] relative">
        <header class="h-20 bg-white/80 backdrop-blur-md border-b border-slate-100 flex items-center justify-between px-8 sticky top-0 z-20">
            <h1 class="text-xl font-extrabold text-slate-800" id="page-title">è´¢åŠ¡æ€»è§ˆçœ‹æ¿</h1>
            <div class="flex items-center gap-4">
                <div class="hidden md:flex flex-col items-end px-3 py-1 bg-slate-50 rounded-lg border border-slate-200">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">æ‰§è¡Œæ±‡ç‡ (USD/CNY)</span>
                    <span id="header-rate" class="text-sm font-black text-emerald-600">--.--</span>
                </div>
                <button onclick="window.location.reload()" class="text-xs font-bold text-slate-400 hover:text-emerald-600">åˆ·æ–°æ•°æ®</button>
            </div>
        </header>

        <div class="p-8 max-w-7xl mx-auto space-y-8">

            <div id="tab-overview" class="tab-content active space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="finance-gradient rounded-3xl p-6 text-white shadow-lg shadow-emerald-200 relative overflow-hidden" onclick="switchTab('withdrawals')">
                        <div class="absolute -right-6 -top-6 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                        <p class="text-[10px] font-bold uppercase tracking-widest text-emerald-100 mb-1 relative z-10">å¾…å‘æ”¾ä½£é‡‘ (04_commission)</p>
                        <h3 class="text-3xl font-black mb-4 relative z-10">Â¥<span id="stat-pending-payout">0.00</span></h3>
                        <div class="text-[10px] bg-white/20 px-3 py-1 rounded-full w-fit relative z-10">å‰å¾€å‘æ”¾ â”</div>
                    </div>
                    
                    <div class="glass-card rounded-3xl p-6 shadow-sm hover:-translate-y-1 transition-transform" onclick="switchTab('costs')">
                        <p class="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-1">å¾…å½•å…¥æˆæœ¬è®¢å• (02_order)</p>
                        <h3 class="text-2xl font-black text-slate-800 mt-1"><span id="stat-pending-cost">0</span> <span class="text-sm font-medium text-slate-400">å•</span></h3>
                        <p class="text-xs text-red-500 font-bold mt-2">5é¡¹æˆæœ¬å…¨ç©º/0</p>
                    </div>

                    <div class="glass-card rounded-3xl p-6 shadow-sm hover:-translate-y-1 transition-transform" onclick="switchTab('compensations')">
                        <p class="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-1">ç§Ÿèµå½’è¿˜å¾…å®¡ (03_digital)</p>
                        <h3 class="text-2xl font-black text-slate-800 mt-1"><span id="stat-pending-return">0</span> <span class="text-sm font-medium text-slate-400">è®¾å¤‡</span></h3>
                        <p class="text-xs text-slate-400 mt-2">ç‚¹å‡»å¤„ç†å½’è¿˜ä¸å®šæŸ</p>
                    </div>
                </div>
            </div>

            <div id="tab-costs" class="tab-content space-y-8">
                <div class="bg-white rounded-3xl border border-red-100 shadow-sm overflow-hidden">
                    <div class="p-6 border-b border-red-50 bg-red-50/30 flex justify-between items-center">
                        <div>
                            <h3 class="font-bold text-slate-800 flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span> å¾…å½•å…¥æˆæœ¬ (æ‰€æœ‰é¡¹ä¸º0)</h3>
                            <p class="text-xs text-slate-400 mt-1">è¯·å½•å…¥æˆæœ¬å¹¶ä¿å­˜ã€‚ä¿å­˜åè®¢å•å°†ç§»è‡³ä¸‹æ–¹"å¾…ç»“ç®—"åˆ—è¡¨ã€‚</p>
                        </div>
                        <span class="px-2 py-1 bg-red-100 text-red-600 rounded text-xs font-bold" id="badge-pending-entry">0 å•</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm min-w-[1000px]">
                            <thead class="bg-slate-50 text-[10px] uppercase text-slate-400 font-bold">
                                <tr>
                                    <th class="p-4 pl-6 w-32">è®¢å•å·</th>
                                    <th class="p-4 w-24">æ”¶å…¥(CNY)</th>
                                    <th class="p-4 w-28 bg-red-50/50 text-red-800">å·¥å‚æˆæœ¬</th>
                                    <th class="p-4 w-28 bg-red-50/50 text-red-800">ç‰©æµæˆæœ¬</th>
                                    <th class="p-4 w-28 bg-red-50/50 text-red-800">åŒ…è£…ç¨è´¹</th>
                                    <th class="p-4 w-28 bg-red-50/50 text-red-800">å…¶ä»–æˆæœ¬</th>
                                    <th class="p-4 w-24">é¢„ä¼°æ¯›åˆ©</th>
                                    <th class="p-4 text-right pr-6">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="cost-entry-body" class="text-slate-700"></tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white rounded-3xl border border-emerald-100 shadow-sm overflow-hidden">
                    <div class="p-6 border-b border-emerald-50 bg-emerald-50/30 flex justify-between items-center">
                        <div>
                            <h3 class="font-bold text-slate-800 flex items-center gap-2"><span class="w-2 h-2 rounded-full bg-emerald-500"></span> å¾…ç¡®è®¤ç»“ç®— (å·²æœ‰æˆæœ¬æ•°æ®)</h3>
                            <p class="text-xs text-slate-400 mt-1">ç¡®è®¤æ•°æ®æ— è¯¯åç‚¹å‡»"ç»“ç®—"ï¼Œç³»ç»Ÿå°†é”å®šåˆ©æ¶¦å¹¶å…è®¸ä½£é‡‘å‘æ”¾ã€‚</p>
                        </div>
                        <span class="px-2 py-1 bg-emerald-100 text-emerald-600 rounded text-xs font-bold" id="badge-pending-settle">0 å•</span>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm min-w-[1000px]">
                            <thead class="bg-slate-50 text-[10px] uppercase text-slate-400 font-bold">
                                <tr>
                                    <th class="p-4 pl-6 w-32">è®¢å•å·</th>
                                    <th class="p-4 w-24">æ”¶å…¥(CNY)</th>
                                    <th class="p-4 w-28 text-slate-500">å·¥å‚æˆæœ¬</th>
                                    <th class="p-4 w-28 text-slate-500">ç‰©æµæˆæœ¬</th>
                                    <th class="p-4 w-28 text-slate-500">åŒ…è£…ç¨è´¹</th>
                                    <th class="p-4 w-28 text-slate-500">å…¶ä»–æˆæœ¬</th>
                                    <th class="p-4 w-24">å®é™…æ¯›åˆ©</th>
                                    <th class="p-4 text-right pr-6">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="cost-settle-body" class="text-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-compensations" class="tab-content space-y-6">
                <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
                    <div class="p-6 border-b border-slate-50 flex justify-between items-center">
                        <h3 class="font-bold text-slate-800">è®¾å¤‡å½’è¿˜ä¸èµ”å¿æ ¸ç®— (03_digital_kit)</h3>
                        <p class="text-xs text-slate-400">ä»…æ˜¾ç¤ºæœªå½’è¿˜(is_returned=false)çš„è®¾å¤‡</p>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 text-[10px] uppercase text-slate-400 font-bold">
                                <tr>
                                    <th class="p-4 pl-6">è®¢å•å·</th>
                                    <th class="p-4">ç§Ÿèµæ¨¡å¼</th>
                                    <th class="p-4 w-48">æŸåç¨‹åº¦ (ä¸‹æ‹‰é€‰æ‹©)</th> <th class="p-4">å·²æ”¶æŠ¼é‡‘</th>
                                    <th class="p-4 text-right pr-6">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="comp-table-body" class="text-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-withdrawals" class="tab-content space-y-6">
                <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
                    <div class="p-6 border-b border-slate-50 flex justify-between items-center">
                        <h3 class="font-bold text-slate-800">ä½£é‡‘å‘æ”¾ (04_commission_summary)</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 text-[10px] uppercase text-slate-400 font-bold">
                                <tr>
                                    <th class="p-4 pl-6">ç»“ç®—æœˆä»½</th>
                                    <th class="p-4">æ”¶æ¬¾äºº (User ID)</th>
                                    <th class="p-4">åº”å‘æ€»é¢</th>
                                    <th class="p-4">å½“å‰çŠ¶æ€</th>
                                    <th class="p-4 text-right pr-6">è´¢åŠ¡ç¡®è®¤</th>
                                </tr>
                            </thead>
                            <tbody id="payout-table-body" class="text-slate-700"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-exchange" class="tab-content space-y-6">
                <div class="bg-white p-8 rounded-3xl border border-slate-100 shadow-sm max-w-lg mx-auto">
                    <h3 class="font-bold text-slate-800 mb-6">æ±‡ç‡å¹²é¢„ (08_exchange_rate)</h3>
                    <div class="space-y-4">
                        <div class="p-4 bg-slate-50 rounded-xl">
                            <p class="text-xs text-slate-500 mb-1">OpenClaw æŠ“å–ä¸­é—´ä»·</p>
                            <p class="text-2xl font-black text-slate-800" id="rate-mid">--.--</p>
                        </div>
                        <div class="p-4 bg-emerald-50 rounded-xl border border-emerald-100">
                            <p class="text-xs text-emerald-600 mb-1 font-bold">å½“å‰ç³»ç»Ÿæ‰§è¡Œæ±‡ç‡ (å«1%ç¼“å†²)</p>
                            <p class="text-3xl font-black text-emerald-600" id="rate-exec">--.--</p>
                        </div>
                        <div class="pt-4 border-t border-slate-100">
                            <label class="block text-xs font-bold text-slate-500 mb-2">æ‰‹åŠ¨å¼ºåˆ¶é”å®šæ±‡ç‡</label>
                            <div class="flex gap-2">
                                <input type="number" step="0.01" id="manual-rate" placeholder="7.00" class="flex-1 bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm font-bold">
                                <button onclick="saveManualRate()" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-emerald-600 transition-colors">é”å®š</button>
                            </div>
                            <p class="text-[10px] text-slate-400 mt-2">æ³¨æ„ï¼šé”å®šåå°†è¦†ç›–è‡ªåŠ¨æŠ“å–çš„æ•°æ®ã€‚</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-profile" class="tab-content space-y-6">
                <div class="bg-white rounded-3xl p-8 border border-slate-100 shadow-sm flex flex-col md:flex-row items-center gap-8">
                    <div id="profile-avatar" class="w-24 h-24 rounded-full bg-emerald-100 flex items-center justify-center text-4xl font-black text-emerald-600 shrink-0">FI</div>
                    <div class="flex-1 text-center md:text-left">
                        <h2 id="profile-name" class="text-2xl font-extrabold text-slate-800 mb-1">CFO Office</h2>
                        <p class="text-sm font-bold text-slate-500 mb-4">ç³»ç»Ÿè§’è‰²ï¼š<span class="text-emerald-600">è´¢åŠ¡ç®¡ç† (Finance)</span></p>
                        <div class="flex flex-wrap gap-3 justify-center md:justify-start">
                            <span class="px-3 py-1 bg-slate-50 border border-slate-200 rounded-lg text-xs font-bold text-slate-600">æ‰€å±éƒ¨é—¨ï¼šç»“ç®—ä¸­å¿ƒ</span>
                            <span id="profile-user-id" class="px-3 py-1 bg-slate-50 border border-slate-200 rounded-lg text-xs font-bold text-slate-600">å·¥å·ï¼šFIN-001</span>
                            <span class="px-3 py-1 bg-red-50 text-red-600 border border-red-100 rounded-lg text-xs font-bold">æœ€é«˜æ•°æ®ä¿å¯†çº§åˆ«</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white rounded-3xl p-8 border border-slate-100 shadow-sm">
                            <h3 class="font-bold text-slate-800 mb-6 text-lg">è”ç³»æ–¹å¼</h3>
                            <p class="text-xs text-slate-500 mb-6">æ­¤ä¿¡æ¯å°†ç”¨äºæ¥æ”¶ç³»ç»Ÿçš„å¼‚å¸¸è´¦å•å‘Šè­¦ã€æç°ç”³è¯·é€šçŸ¥ï¼Œä»¥åŠå¯¹å†…è”ç»œæ²Ÿé€šã€‚</p>
                            
                            <form id="profile-form" class="space-y-5">
                                <div>
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest block mb-2">ğŸ“§ é‚®ç®± (Email)</label>
                                    <input type="email" id="profile-email" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white focus:border-emerald-500 outline-none transition-all text-sm font-medium">
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                    <div>
                                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest block mb-2">ğŸ’¬ å¾®ä¿¡ (WeChat)</label>
                                        <input type="text" id="profile-wechat" placeholder="è¯·è¾“å…¥å¾®ä¿¡å·" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white focus:border-emerald-500 outline-none transition-all text-sm font-medium">
                                    </div>
                                    <div>
                                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest block mb-2">ğŸ“± WhatsApp</label>
                                        <input type="text" id="profile-whatsapp" placeholder="+86..." class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white focus:border-emerald-500 outline-none transition-all text-sm font-medium">
                                    </div>
                                </div>

                                <div class="pt-4">
                                    <button id="btn-save-settings" type="button" onclick="saveFinanceSettings()" class="bg-slate-900 text-white px-8 py-3.5 rounded-xl font-bold shadow-lg hover:bg-emerald-600 transition-all text-sm">ğŸ’¾ ä¿å­˜è”ç³»æ–¹å¼</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-red-50/50 rounded-3xl p-8 border border-red-100 shadow-sm">
                            <h3 class="text-lg font-bold text-red-600 mb-2">èµ„é‡‘å®‰å…¨ä¸é€€å‡º</h3>
                            <p class="text-xs text-red-400 mb-6 leading-relaxed">ç¦»å¼€ç”µè„‘å‰è¯·åŠ¡å¿…å®‰å…¨é€€å‡ºï¼Œé˜²æ­¢è´¢åŠ¡æ•°æ®æ³„éœ²ã€‚</p>
                            
                            <div class="flex flex-col gap-3">
                                <button onclick="logout()" class="w-full py-3 bg-white border border-slate-200 text-slate-700 rounded-xl font-bold text-xs hover:bg-slate-50 hover:text-emerald-600 transition-all shadow-sm flex items-center justify-center gap-2 group">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 group-hover:stroke-emerald-600 transition-colors">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" />
                                    </svg>
                                    å®‰å…¨ç™»å‡º
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <script>
        const SUPABASE_URL = 'https://xxouixhnhauvgrrchako.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4b3VpeGhuaGF1dmdycmNoYWtvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxNTk2NjYsImV4cCI6MjA4NTczNTY2Nn0.ph24qP9wXOAvsblwkobH9MhSrDFJ4g5vyGof7aUjjVw';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // èµ”å¿æ ‡å‡†å¸¸é‡
        const DAMAGE_COSTS = {
            'æ­£å¸¸ç£¨æŸ': 0,
            'å±å¹•æŸå': 200,
            'å¤–å£³ä¸¥é‡æŸå': 300,
            'åŠŸèƒ½æŸå': 400,
            'æ‰‹æœºä¸¢å¤±': 700
        };

        let globalData = { ordersEntry: [], ordersSettle: [], commissions: [], digitalOrders: [], rate: null, currentUser: null };

        window.addEventListener('DOMContentLoaded', async () => {
            loadUserProfile(); 
            await loadAllData();
            document.getElementById('loadingOverlay').style.display = 'none';
        });

        // ===================== ä¸ªäººä¸­å¿ƒé€»è¾‘ =====================
        function loadUserProfile() {
            const storedUser = localStorage.getItem('baisheng_user');
            if (storedUser) {
                globalData.currentUser = JSON.parse(storedUser);
            } else {
                globalData.currentUser = { real_name: 'CFO Office', user_id: 'FIN-001', role: 'è´¢åŠ¡' };
            }
            updateUserInfo(globalData.currentUser);
        }

        function updateUserInfo(user) {
            document.getElementById('user-avatar').textContent = 'FI';
            document.getElementById('user-name').textContent = user.real_name || 'CFO Office';
            document.getElementById('user-id').textContent = 'ID: ' + (user.user_id || 'FIN-001');
            
            document.getElementById('profile-avatar').textContent = 'FI';
            document.getElementById('profile-name').textContent = user.real_name || 'CFO Office';
            document.getElementById('profile-user-id').textContent = 'å·¥å·ï¼š' + (user.user_id || 'FIN-001');
            
            document.getElementById('profile-email').value = user.email || '';
            document.getElementById('profile-wechat').value = user.wechat || '';
            document.getElementById('profile-whatsapp').value = user.whatsapp || '';
        }

        async function saveFinanceSettings() {
            const btn = document.getElementById('btn-save-settings');
            const origText = btn.innerHTML;
            btn.innerHTML = 'ä¿å­˜ä¸­...';
            btn.disabled = true;

            try {
                const updates = {
                    email: document.getElementById('profile-email').value,
                    wechat: document.getElementById('profile-wechat').value,
                    whatsapp: document.getElementById('profile-whatsapp').value
                };
                
                if(globalData.currentUser && globalData.currentUser.user_id && globalData.currentUser.user_id.length > 10) {
                    const { error } = await supabase.from('01_user_master').update(updates).eq('user_id', globalData.currentUser.user_id);
                    if (error) throw error;
                    globalData.currentUser = { ...globalData.currentUser, ...updates };
                    localStorage.setItem('baisheng_user', JSON.stringify(globalData.currentUser));
                    alert('âœ… è”ç³»æ–¹å¼å·²æ›´æ–°ï¼');
                } else {
                    alert('âš ï¸ æ¼”ç¤ºæ¨¡å¼å·²æ›´æ–°å‰ç«¯ç¼“å­˜ã€‚');
                }
            } catch (error) {
                alert('ä¿å­˜å¤±è´¥ï¼š' + error.message);
            } finally {
                btn.innerHTML = origText;
                btn.disabled = false;
            }
        }

        // ===================== æ•°æ®åŠ è½½ =====================
        async function loadAllData() {
            // 1. æ±‡ç‡
            const { data: rates } = await supabase.from('08_exchange_rate').select('*').order('captured_at', {ascending: false}).limit(1);
            if(rates && rates[0]) {
                globalData.rate = rates[0];
                document.getElementById('header-rate').textContent = parseFloat(rates[0].exec_rate).toFixed(4);
                document.getElementById('rate-mid').textContent = rates[0].xtransfer_mid;
                document.getElementById('rate-exec').textContent = parseFloat(rates[0].exec_rate).toFixed(4);
            }

            // 2. æˆæœ¬å½•å…¥
            try {
                const { data: orders } = await supabase.from('02_order_master').select('*').eq('status', 'è¿›è¡Œä¸­').order('updated_at', { ascending: false });
                if(orders) {
                    globalData.ordersEntry = orders.filter(o => isZero(o.cost_product) && isZero(o.cost_logistics) && isZero(o.cost_tax_pack) && isZero(o.cost_other) && isZero(o.total_cost));
                    globalData.ordersSettle = orders.filter(o => !isZero(o.total_cost) || !isZero(o.cost_product) || !isZero(o.cost_logistics) || !isZero(o.cost_tax_pack) || !isZero(o.cost_other));
                }
            } catch (err) { console.error("Order error", err); }

            // 3. ä½£é‡‘å‘æ”¾
            const { data: comms } = await supabase.from('04_commission_summary').select('*').or('settle_status.eq.å¾…å‘æ”¾,settle_status.eq.æ ¸ç®—ä¸­').order('year_month', {ascending: false});
            globalData.commissions = comms || [];

            // 4. èµ”å¿å®¡æ ¸
            const { data: digitals } = await supabase.from('03_digital_kit_orders').select('*').eq('is_returned', false);
            globalData.digitalOrders = digitals || [];

            renderDashboard();
        }

        function isZero(val) { return val === null || val === undefined || parseFloat(val) === 0; }

        function renderDashboard() {
            document.getElementById('stat-pending-payout').textContent = globalData.commissions.reduce((acc, c) => acc + parseFloat(c.total_amount||0), 0).toFixed(2);
            document.getElementById('stat-pending-cost').textContent = globalData.ordersEntry.length; 
            document.getElementById('stat-pending-return').textContent = globalData.digitalOrders.length;
            document.getElementById('badge-pending-entry').textContent = globalData.ordersEntry.length + ' å•';
            document.getElementById('badge-pending-settle').textContent = globalData.ordersSettle.length + ' å•';
            renderCostTables();
            renderPayoutTable();
            renderCompTable();
        }

        function renderCostTables() {
            const entryBody = document.getElementById('cost-entry-body');
            entryBody.innerHTML = globalData.ordersEntry.map(o => createCostRow(o, true)).join('') || '<tr><td colspan="8" class="p-6 text-center text-slate-400 text-xs">æš‚æ— å¾…å½•å…¥è®¢å•</td></tr>';
            const settleBody = document.getElementById('cost-settle-body');
            settleBody.innerHTML = globalData.ordersSettle.map(o => createCostRow(o, false)).join('') || '<tr><td colspan="8" class="p-6 text-center text-slate-400 text-xs">æš‚æ— å¾…ç»“ç®—è®¢å•</td></tr>';
        }

        function createCostRow(o, isEntry) {
            const amount = parseFloat(o.amount_cny || 0);
            const cp = parseFloat(o.cost_product || 0); const cl = parseFloat(o.cost_logistics || 0);
            const ctp = parseFloat(o.cost_tax_pack || 0); const co = parseFloat(o.cost_other || 0);
            const totalCost = cp + cl + ctp + co; const profit = amount - totalCost;
            const pid = o.order_id;

            if (isEntry) {
                return `<tr class="border-b border-red-50 hover:bg-red-50/20 transition-all"><td class="p-4 pl-6 font-mono text-xs font-bold text-slate-600">${pid}</td><td class="p-4 text-xs font-bold">Â¥${amount.toFixed(2)}</td><td class="p-4"><input type="number" id="cp-${pid}" class="cost-input" placeholder="0.00" onchange="calcLocalProfit('${pid}', ${amount})"></td><td class="p-4"><input type="number" id="cl-${pid}" class="cost-input" placeholder="0.00" onchange="calcLocalProfit('${pid}', ${amount})"></td><td class="p-4"><input type="number" id="ctp-${pid}" class="cost-input" placeholder="0.00" onchange="calcLocalProfit('${pid}', ${amount})"></td><td class="p-4"><input type="number" id="co-${pid}" class="cost-input" placeholder="0.00" onchange="calcLocalProfit('${pid}', ${amount})"></td><td class="p-4 font-bold text-xs text-slate-400" id="profit-${pid}">å¾…è®¡ç®—</td><td class="p-4 text-right pr-6"><button onclick="saveCost('${pid}', ${amount})" class="px-3 py-1.5 bg-red-600 text-white rounded text-xs font-bold shadow hover:bg-red-700 transition-all">ä¿å­˜æ•°æ®</button></td></tr>`;
            } else {
                return `<tr class="border-b border-emerald-50 hover:bg-emerald-50/20 transition-all"><td class="p-4 pl-6 font-mono text-xs font-bold text-slate-600">${pid}</td><td class="p-4 text-xs font-bold">Â¥${amount.toFixed(2)}</td><td class="p-4"><input type="number" id="cp-${pid}" value="${cp}" class="cost-input cost-input-readonly" readonly></td><td class="p-4"><input type="number" id="cl-${pid}" value="${cl}" class="cost-input cost-input-readonly" readonly></td><td class="p-4"><input type="number" id="ctp-${pid}" value="${ctp}" class="cost-input cost-input-readonly" readonly></td><td class="p-4"><input type="number" id="co-${pid}" value="${co}" class="cost-input cost-input-readonly" readonly></td><td class="p-4 font-bold text-xs ${profit>=0?'text-emerald-600':'text-red-500'}">Â¥${profit.toFixed(2)}</td><td class="p-4 text-right pr-6 flex justify-end gap-2"><button onclick="enableEdit('${pid}')" class="px-2 py-1 bg-slate-100 text-slate-600 rounded text-xs font-bold hover:bg-slate-200">ä¿®æ”¹</button><button onclick="settleOrder('${pid}')" class="px-3 py-1 bg-emerald-600 text-white rounded text-xs font-bold shadow hover:bg-emerald-700">ç¡®è®¤ç»“ç®—</button><button onclick="saveCost('${pid}', ${amount})" id="btn-save-${pid}" class="hidden px-2 py-1 bg-blue-600 text-white rounded text-xs font-bold">ä¿å­˜</button></td></tr>`;
            }
        }

        function calcLocalProfit(oid, amount) {
            const cp = parseFloat(document.getElementById('cp-'+oid).value) || 0; const cl = parseFloat(document.getElementById('cl-'+oid).value) || 0;
            const ctp = parseFloat(document.getElementById('ctp-'+oid).value) || 0; const co = parseFloat(document.getElementById('co-'+oid).value) || 0;
            const total = cp + cl + ctp + co; const profit = amount - total;
            const el = document.getElementById('profit-'+oid);
            if(el) { el.textContent = 'Â¥' + profit.toFixed(2); el.className = `p-4 font-bold text-xs ${profit>=0?'text-emerald-600':'text-red-500'}`; }
        }

        function enableEdit(pid) {
            ['cp','cl','ctp','co'].forEach(prefix => {
                const el = document.getElementById(prefix+'-'+pid); el.readOnly = false; el.classList.remove('cost-input-readonly'); el.classList.add('bg-white', 'border-blue-300');
            });
            document.getElementById('btn-save-'+pid).classList.remove('hidden');
        }

        function renderPayoutTable() {
            const tbody = document.getElementById('payout-table-body');
            tbody.innerHTML = globalData.commissions.map(c => `
                <tr class="border-b border-slate-50">
                    <td class="p-4 pl-6 text-xs font-mono">${c.year_month}</td><td class="p-4 text-xs font-bold">${c.user_id}</td>
                    <td class="p-4 font-black text-emerald-600">Â¥${parseFloat(c.total_amount).toFixed(2)}</td>
                    <td class="p-4"><span class="px-2 py-1 bg-amber-50 text-amber-600 rounded text-[10px] font-bold">${c.settle_status}</span></td>
                    <td class="p-4 text-right pr-6"><button onclick="confirmPayout('${c.summary_id}')" class="px-3 py-1.5 bg-emerald-600 text-white rounded text-xs font-bold hover:bg-emerald-700 transition-all shadow-sm">ç¡®è®¤å·²æ‰“æ¬¾</button></td>
                </tr>
            `).join('') || '<tr><td colspan="5" class="p-6 text-center text-slate-400 text-xs">æš‚æ— å¾…å‘æ”¾ä½£é‡‘</td></tr>';
        }

        // --- èµ”å¿è¡¨ (è¡¨æ ¼å†…ç›´æ¥ä¸‹æ‹‰é€‰æ‹©) ---
        function renderCompTable() {
            const tbody = document.getElementById('comp-table-body');
            tbody.innerHTML = globalData.digitalOrders.map(d => `
                <tr class="border-b border-slate-50 hover:bg-slate-50/50">
                    <td class="p-4 pl-6 font-mono text-xs">${d.order_id}</td>
                    <td class="p-4 text-xs"><span class="bg-blue-50 text-blue-600 px-2 py-1 rounded font-bold">${d.mode}</span></td>
                    <td class="p-4">
                        <select id="damage-${d.order_id}" class="w-40 bg-white border border-slate-200 rounded px-2 py-1 text-xs outline-none focus:border-emerald-500 font-bold text-slate-700 cursor-pointer">
                            <option value="æ­£å¸¸ç£¨æŸ">âœ… æ­£å¸¸ç£¨æŸ (Â¥0)</option>
                            <option value="å±å¹•æŸå">ğŸ“± å±å¹•æŸå (Â¥200)</option>
                            <option value="å¤–å£³ä¸¥é‡æŸå">ğŸ”¨ å¤–å£³ä¸¥é‡ (Â¥300)</option>
                            <option value="åŠŸèƒ½æŸå">ğŸ”Œ åŠŸèƒ½æŸå (Â¥400)</option>
                            <option value="æ‰‹æœºä¸¢å¤±">âŒ æ‰‹æœºä¸¢å¤± (Â¥700)</option>
                        </select>
                    </td>
                    <td class="p-4 text-xs font-bold">Â¥${parseFloat(d.deposit).toFixed(2)}</td>
                    <td class="p-4 text-right pr-6">
                        <button onclick="confirmReturn('${d.order_id}', ${d.deposit})" class="px-4 py-1.5 bg-slate-800 text-white rounded text-xs font-bold hover:bg-slate-900 shadow-sm transition-all">ç¡®å®šå½’è¿˜</button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="5" class="p-6 text-center text-slate-400 text-xs">æš‚æ— å¾…å½’è¿˜è®¾å¤‡</td></tr>';
        }

        // --- æ ¸å¿ƒäº¤äº’ ---
        
        async function confirmReturn(orderId, deposit) {
            const selectEl = document.getElementById('damage-' + orderId);
            const damageLevel = selectEl.value;
            const cost = DAMAGE_COSTS[damageLevel];
            const refund = Math.max(0, deposit - cost);

            if(!confirm(`âš ï¸ å½’è¿˜æ ¸ç®—ç¡®è®¤ï¼š\n\nè®¾å¤‡çŠ¶æ€: ${damageLevel}\nåº”æ‰£èµ”å¿: Â¥${cost}\nåº”é€€æŠ¼é‡‘: Â¥${refund.toFixed(2)}\n\næ˜¯å¦ç¡®è®¤å¹¶æäº¤ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) return;

            document.getElementById('loadingOverlay').style.display = 'flex';
            const { error } = await supabase.from('03_digital_kit_orders').update({
                is_returned: true,
                damage_level: damageLevel,
                compensation: cost
            }).eq('order_id', orderId);

            if(error) alert('æ“ä½œå¤±è´¥: ' + error.message);
            else { alert('âœ… å½’è¿˜æˆåŠŸï¼Œèµ”å¿é‡‘å·²è®°å½•'); await loadAllData(); }
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        async function saveCost(oid, amount) {
            const cp = parseFloat(document.getElementById('cp-'+oid).value) || 0;
            const cl = parseFloat(document.getElementById('cl-'+oid).value) || 0;
            const ctp = parseFloat(document.getElementById('ctp-'+oid).value) || 0;
            const co = parseFloat(document.getElementById('co-'+oid).value) || 0;
            const totalCost = cp + cl + ctp + co;
            const profit = amount - totalCost;
            document.getElementById('loadingOverlay').style.display = 'flex';
            const { error } = await supabase.from('02_order_master').update({
                cost_product: cp, cost_logistics: cl, cost_tax_pack: ctp, cost_other: co,
                total_cost: totalCost, gross_profit: profit, updated_at: new Date().toISOString()
            }).eq('order_id', oid);
            if(error) alert('ä¿å­˜å¤±è´¥: ' + error.message);
            else { alert('æˆæœ¬å·²ä¿å­˜ï¼Œè¯·åœ¨"å¾…ç»“ç®—"åˆ—è¡¨ç¡®è®¤ã€‚'); await loadAllData(); }
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        async function settleOrder(oid) {
            if(!confirm('ç¡®è®¤ç»“ç®—æ­¤è®¢å•ï¼Ÿè¿™å°†é”å®šåˆ©æ¶¦å¹¶å…è®¸è®¡ç®—ä½£é‡‘ã€‚')) return;
            const { error } = await supabase.from('02_order_master').update({ status: 'å·²å®Œæˆ' }).eq('order_id', oid);
            if(error) alert('ç»“ç®—å¤±è´¥: ' + error.message);
            else { alert('è®¢å•å·²ç»“ç®—'); await loadAllData(); }
        }

        async function confirmPayout(sid) {
            if(!confirm('ç¡®è®¤å·²å‘è¯¥ç”¨æˆ·æ‰“æ¬¾ï¼ŸçŠ¶æ€å°†æ›´æ–°ä¸ºå·²å‘æ”¾ã€‚')) return;
            const { error } = await supabase.from('04_commission_summary').update({ settle_status: 'å·²å‘æ”¾', paid_at: new Date().toISOString() }).eq('summary_id', sid);
            if(error) alert('æ“ä½œå¤±è´¥: ' + error.message);
            else { alert('å‘æ”¾æˆåŠŸ'); await loadAllData(); }
        }

        async function saveManualRate() {
            const val = document.getElementById('manual-rate').value;
            if(!val) return alert('è¯·è¾“å…¥æ±‡ç‡');
            const now = new Date().toISOString(); 
            const today = now.split('T')[0];
            const { error } = await supabase.from('08_exchange_rate').insert({
                rate_date: today,
                captured_at: now,
                currency: 'USD',
                xtransfer_mid: val, 
                exec_rate: val,
                is_manual: true
            });
            if(error) alert('æ“ä½œå¤±è´¥: '+error.message);
            else { alert('æ±‡ç‡å·²é”å®š'); window.location.reload(); }
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-' + id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e => {
                e.classList.remove('bg-emerald-50', 'text-emerald-700', 'font-bold');
                e.classList.add('text-slate-500');
            });
            document.getElementById('nav-' + id).classList.add('bg-emerald-50', 'text-emerald-700', 'font-bold');
        }

        function logout() { localStorage.removeItem('baisheng_user'); window.location.reload(); }
    </script>
</body>
</html>