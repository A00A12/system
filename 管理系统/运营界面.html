<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿è¥å·¥ä½œå° v5.3 | æŸç››å…¨çƒåˆä¼™äºº</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.8/dist/umd/supabase.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .tab-content { display: none; animation: fadeIn 0.3s ease-in-out; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .ops-gradient { background: linear-gradient(135deg, #f97316 0%, #f59e0b 100%); }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(241, 245, 249, 1); }
        .loading-overlay { position: fixed; inset: 0; background: rgba(255,255,255,0.9); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .spinner { width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top-color: #f97316; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-slate-900 h-screen flex overflow-hidden">

    <div id="loadingOverlay" class="loading-overlay"><div class="spinner"></div></div>

    <aside class="w-64 bg-white border-r border-slate-100 hidden md:flex flex-col justify-between h-full z-30 shadow-sm">
        <div>
            <div class="h-20 flex items-center px-8 border-b border-slate-50">
                <span class="text-xl font-black text-orange-600 tracking-tight">æŸç››è¿è¥ <span class="text-xs text-slate-400 font-medium">v5.3</span></span>
            </div>
            <nav class="p-4 space-y-2 mt-4">
                <button onclick="switchTab('overview')" id="nav-overview" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl bg-orange-50 text-orange-700 font-bold transition-all">
                    <span>ğŸ“Š</span> è¿è¥æ€»è§ˆ
                </button>
                <button onclick="switchTab('tasks')" id="nav-tasks" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 font-medium transition-all">
                    <span>ğŸ“‹</span> ä»»åŠ¡å‘å¸ƒä¸ç®¡ç†
                </button>
                <button onclick="switchTab('audits')" id="nav-audits" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 font-medium transition-all">
                    <span>ğŸ›¡ï¸</span> å®¡æ ¸ä¸­å¿ƒ
                </button>
                <button onclick="switchTab('users')" id="nav-users" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 font-medium transition-all">
                    <span>ğŸ‘¥</span> äººå‘˜åˆ†é…ä¸ä»£å¡«
                </button>
                <div class="pt-4 mt-4 border-t border-slate-100"></div>
                <button onclick="switchTab('profile')" id="nav-profile" class="nav-item w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 font-medium transition-all">
                    <span>ğŸ‘¤</span> ä¸ªäººä¸­å¿ƒ
                </button>
            </nav>
        </div>
        <div class="p-4 border-t border-slate-50">
            <div onclick="switchTab('profile')" class="flex items-center gap-3 px-4 py-3 rounded-xl bg-slate-50 cursor-pointer hover:bg-slate-100 transition-all">
                <div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center font-bold text-orange-700">OP</div>
                <div>
                    <div class="text-sm font-bold text-slate-800">Operation</div>
                    <div class="text-[10px] text-slate-500">è¶…çº§ç®¡ç†å‘˜æƒé™</div>
                </div>
            </div>
        </div>
    </aside>

    <main class="flex-1 h-full overflow-y-auto bg-[#f8fafc] relative">
        <header class="h-20 bg-white/80 backdrop-blur-md border-b border-slate-100 flex items-center justify-between px-8 sticky top-0 z-20">
            <h1 class="text-xl font-extrabold text-slate-800" id="page-title">è¿è¥å·¥ä½œå°</h1>
            <div class="flex items-center gap-4">
                <div class="hidden md:flex flex-col items-end px-3 py-1 bg-slate-50 rounded-lg border border-slate-200">
                    <span class="text-[10px] font-bold text-slate-400 uppercase">å½“å‰æ±‡ç‡ (æ‰§è¡Œ)</span>
                    <span id="header-rate" class="text-sm font-black text-slate-800">--.--</span>
                </div>
                <button onclick="window.location.reload()" class="text-xs font-bold text-slate-400 hover:text-orange-600">åˆ·æ–°æ•°æ®</button>
            </div>
        </header>

        <div class="p-8 max-w-7xl mx-auto space-y-8">

            <div id="tab-overview" class="tab-content active space-y-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="ops-gradient rounded-3xl p-6 text-white shadow-lg shadow-orange-200 relative overflow-hidden" onclick="switchTab('audits')">
                        <div class="absolute -right-6 -top-6 w-32 h-32 bg-white/10 rounded-full blur-2xl"></div>
                        <p class="text-[10px] font-bold uppercase tracking-widest text-orange-100 mb-1 relative z-10">å¾…å®¡æ ¸æ³¨å†Œ</p>
                        <h3 class="text-3xl font-black mb-4 relative z-10"><span id="stat-pending-users">0</span> <span class="text-base font-medium">äºº</span></h3>
                        <div class="text-[10px] bg-white/20 px-3 py-1 rounded-full w-fit relative z-10">å‰å¾€å®¡æ ¸ â”</div>
                    </div>
                    
                    <div class="glass-card rounded-3xl p-6 shadow-sm hover:-translate-y-1 transition-transform" onclick="switchTab('tasks')">
                        <p class="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-1">è¿›è¡Œä¸­çš„è¿è¥ä»»åŠ¡</p>
                        <h3 class="text-2xl font-black text-slate-800 mt-1"><span id="stat-active-tasks">0</span> <span class="text-sm font-medium text-slate-400">é¡¹</span></h3>
                        <p class="text-xs text-slate-400 mt-2">å·²å‘å¸ƒåˆ°å¯¹åº”è§’è‰²</p>
                    </div>

                    <div class="glass-card rounded-3xl p-6 shadow-sm hover:-translate-y-1 transition-transform" onclick="switchTab('users')">
                        <p class="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-1">æ€»ç”¨æˆ·æ•°</p>
                        <h3 class="text-2xl font-black text-slate-800 mt-1"><span id="stat-total-users">0</span></h3>
                        <p class="text-[10px] mt-2 text-slate-500">ç‚¹å‡»è¿›è¡Œäººå‘˜åˆ†é…ä¸èµ„æ–™å®Œå–„</p>
                    </div>
                </div>
            </div>

            <div id="tab-tasks" class="tab-content space-y-6">
                <div class="flex justify-between items-end">
                    <div>
                        <h2 class="text-xl font-bold text-slate-800">è¿è¥ä»»åŠ¡ä¸­å¿ƒ</h2>
                        <p class="text-xs text-slate-500 mt-1">å‘å¸ƒå…¨å‘˜é€šçŸ¥æˆ–ç‰¹å®šè§’è‰²çš„å·¥ä½œæŒ‡ä»¤</p>
                    </div>
                    <button onclick="openModal('taskModal')" class="bg-slate-900 text-white px-5 py-2.5 rounded-xl text-sm font-bold shadow-lg hover:bg-orange-600 transition-all flex items-center gap-2">
                        <span>+</span> å‘å¸ƒæ–°ä»»åŠ¡
                    </button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="task-list-container">
                    </div>
            </div>

            <div id="tab-audits" class="tab-content space-y-8">
                <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
                    <div class="p-6 border-b border-slate-50 bg-slate-50/50">
                        <h3 class="font-bold text-slate-800">ğŸ“ æ–°æ³¨å†Œèº«ä»½å®¡æ ¸</h3>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 text-[10px] uppercase text-slate-400 font-bold">
                                <tr>
                                    <th class="p-4 pl-6">ç”¨æˆ·</th>
                                    <th class="p-4">è§’è‰²</th>
                                    <th class="p-4">è¯ä»¶ (è„±æ•)</th>
                                    <th class="p-4 text-right pr-6">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="audit-users-body" class="text-slate-700"></tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white rounded-3xl border border-dashed border-slate-300 shadow-sm overflow-hidden relative">
                    <div class="p-6 border-b border-slate-50 flex justify-between items-center opacity-50">
                        <h3 class="font-bold text-slate-800">ğŸ¬ è§†é¢‘èµ„è´¨å®¡æ ¸</h3>
                        <span class="text-xs text-slate-400">06_task_audit</span>
                    </div>
                    <div class="p-12 text-center bg-slate-50/50">
                        <div class="w-16 h-16 bg-amber-100 text-amber-500 rounded-full flex items-center justify-center text-2xl mx-auto mb-4">ğŸš§</div>
                        <h3 class="text-lg font-bold text-slate-800">åŠŸèƒ½å¼€å‘ä¸­</h3>
                        <p class="text-sm text-slate-500 mt-2">è§†é¢‘å®¡æ ¸æ¨¡å—æ­£åœ¨å‡çº§ä¸­ï¼Œæš‚æ—¶æ— æ³•æ“ä½œã€‚</p>
                    </div>
                </div>
            </div>

            <div id="tab-users" class="tab-content space-y-6">
                <div class="bg-white rounded-3xl border border-slate-100 shadow-sm overflow-hidden">
                    <div class="p-6 border-b border-slate-50 flex justify-between items-center">
                        <h3 class="font-bold text-slate-800">å…¨å‘˜èŠ±åå†Œ</h3>
                        <input type="text" id="search-input" onkeyup="renderUsers()" placeholder="æœç´¢å§“å..." class="bg-slate-50 border border-slate-200 text-xs px-3 py-2 rounded-lg outline-none focus:border-orange-500">
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-slate-50 text-[10px] uppercase text-slate-400 font-bold">
                                <tr>
                                    <th class="p-4 pl-6">å§“å/ç”µè¯</th>
                                    <th class="p-4">è§’è‰²</th>
                                    <th class="p-4">VIPç­‰çº§</th>
                                    <th class="p-4">ä¸Šçº§/æ¨èäºº</th>
                                    <th class="p-4 text-right pr-6">ç®¡ç†æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="users-list-body" class="text-slate-700 font-medium"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-profile" class="tab-content space-y-6">
                <div class="bg-white rounded-3xl p-8 border border-slate-100 shadow-sm flex flex-col md:flex-row items-center gap-8">
                    <div id="profile-avatar-large" class="w-24 h-24 rounded-full bg-orange-100 flex items-center justify-center text-4xl font-black text-orange-600 shrink-0">OP</div>
                    <div class="flex-1 text-center md:text-left">
                        <h2 id="profile-name" class="text-2xl font-extrabold text-slate-800 mb-1">Emma (Operations)</h2>
                        <p class="text-sm font-bold text-slate-500 mb-4">ç³»ç»Ÿè§’è‰²ï¼š<span class="text-orange-600">è¿è¥ (Operations)</span></p>
                        <div class="flex flex-wrap gap-3 justify-center md:justify-start">
                            <span class="px-3 py-1 bg-slate-50 border border-slate-200 rounded-lg text-xs font-bold text-slate-600">æ‰€å±éƒ¨é—¨ï¼šå¹³å°è¿è¥ä¸­å¿ƒ</span>
                            <span id="profile-user-id" class="px-3 py-1 bg-slate-50 border border-slate-200 rounded-lg text-xs font-bold text-slate-600">å·¥å·ï¼šOPS-003</span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white rounded-3xl p-8 border border-slate-100 shadow-sm">
                            <h3 class="font-bold text-slate-800 mb-6 text-lg">è”ç³»æ–¹å¼</h3>
                            <form id="profile-form" class="space-y-5">
                                <div>
                                    <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest block mb-2">ğŸ“§ é‚®ç®± (Email)</label>
                                    <input type="email" id="profile-email" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white focus:border-orange-500 outline-none transition-all text-sm font-medium">
                                </div>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                                    <div>
                                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest block mb-2">ğŸ’¬ å¾®ä¿¡ (WeChat)</label>
                                        <input type="text" id="profile-wechat" placeholder="è¯·è¾“å…¥å¾®ä¿¡å·" class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white focus:border-orange-500 outline-none transition-all text-sm font-medium">
                                    </div>
                                    <div>
                                        <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest block mb-2">ğŸ“± WhatsApp</label>
                                        <input type="text" id="profile-whatsapp" placeholder="+86..." class="w-full px-4 py-3 rounded-xl bg-slate-50 border border-slate-200 focus:bg-white focus:border-orange-500 outline-none transition-all text-sm font-medium">
                                    </div>
                                </div>

                                <div class="pt-2">
                                    <button id="btn-save-profile" type="button" onclick="saveProfile()" class="bg-slate-900 text-white px-8 py-3.5 rounded-xl font-bold shadow-lg hover:bg-orange-600 transition-all text-sm">ğŸ’¾ ä¿å­˜è”ç³»æ–¹å¼</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <div class="bg-red-50/50 rounded-3xl p-8 border border-red-100 shadow-sm">
                            <h3 class="text-lg font-bold text-red-600 mb-2">è´¦å·ä¸å®‰å…¨</h3>
                            <p class="text-xs text-red-400 mb-6 leading-relaxed">ç®¡ç†æ‚¨çš„ç™»å½•çŠ¶æ€æˆ–ç”³è¯·æ³¨é”€è´¦å·ã€‚</p>
                            <div class="flex flex-col gap-3">
                                <button onclick="logout()" class="w-full py-3 bg-white border border-slate-200 text-slate-700 rounded-xl font-bold text-xs hover:bg-slate-50 hover:text-orange-600 transition-all shadow-sm flex items-center justify-center gap-2 group">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4 group-hover:stroke-orange-600 transition-colors">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" />
                                    </svg>
                                    åˆ‡æ¢è´¦å· / ç™»å‡º
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <div id="taskModal" class="fixed inset-0 z-50 hidden bg-slate-900/40 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-lg mx-4">
            <h3 class="text-xl font-black text-slate-800 mb-6">å‘å¸ƒæ–°ä»»åŠ¡ (06_task_publish)</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">ä»»åŠ¡æ ‡é¢˜</label>
                    <input type="text" id="taskTitle" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2 text-sm font-bold">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">æˆªæ­¢æ—¥æœŸ</label>
                    <input type="date" id="taskDeadline" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2 text-sm">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">æŒ‡æ´¾å¯¹è±¡ (ä¸¥æ ¼é™åˆ¶5ç±»)</label>
                    <select id="taskRole" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2 text-sm font-bold text-slate-700">
                        <option value="ä¸šåŠ¡å‘˜">ğŸ‘” ä¸šåŠ¡å‘˜</option>
                        <option value="è´¢åŠ¡">ğŸ’° è´¢åŠ¡</option>
                        <option value="ä¸šåŠ¡ç»ç†">ğŸ’¼ ä¸šåŠ¡ç»ç†</option>
                        <option value="è¿è¥">ğŸ“Š è¿è¥</option>
                        <option value="ç®¡ç†å‘˜">âš™ï¸ ç®¡ç†å‘˜</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 mb-1">ä»»åŠ¡è¯¦æƒ…</label>
                    <textarea id="taskContent" rows="3" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-2 text-sm"></textarea>
                </div>
            </div>
            <div class="flex gap-3 mt-8">
                <button onclick="closeModal('taskModal')" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold text-sm">å–æ¶ˆ</button>
                <button onclick="submitTask()" class="flex-1 py-3 bg-slate-900 text-white rounded-xl font-bold text-sm hover:bg-orange-600 transition-colors">ç¡®è®¤å‘å¸ƒ</button>
            </div>
        </div>
    </div>

    <div id="assignModal" class="fixed inset-0 z-50 hidden bg-slate-900/40 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4">
            <h3 class="text-lg font-black text-slate-800 mb-2">äººå‘˜åˆ†é… / è°ƒå²—</h3>
            <p class="text-xs text-slate-500 mb-6" id="assignTargetName">æ­£åœ¨è°ƒæ•´: ---</p>
            
            <input type="hidden" id="assignUserId">
            <label class="block text-xs font-bold text-slate-500 mb-1">æ–°æ¨èäºº/ä¸Šçº§ ID (UUID)</label>
            <input type="text" id="newReferrerId" placeholder="è¯·è¾“å…¥ä¸Šçº§çš„ User ID" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-4 py-3 text-sm font-mono mb-6">

            <div class="flex gap-3">
                <button onclick="closeModal('assignModal')" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold text-sm">å–æ¶ˆ</button>
                <button onclick="confirmAssignment()" class="flex-1 py-3 bg-orange-600 text-white rounded-xl font-bold text-sm">ç¡®è®¤è°ƒæ•´</button>
            </div>
        </div>
    </div>

    <div id="editUserModal" class="fixed inset-0 z-50 hidden bg-slate-900/40 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4">
            <h3 class="text-lg font-black text-slate-800 mb-6">èµ„æ–™ä»£å¡« (ä»…é™è”ç³»æ–¹å¼)</h3>
            <input type="hidden" id="editUserId">
            
            <div class="space-y-3">
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase">Email</label>
                    <input type="email" id="editEmail" class="w-full border-b border-slate-200 py-1 text-sm outline-none focus:border-orange-500">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase">WeChat</label>
                    <input type="text" id="editWechat" class="w-full border-b border-slate-200 py-1 text-sm outline-none focus:border-orange-500">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-400 uppercase">WhatsApp</label>
                    <input type="text" id="editWhatsapp" class="w-full border-b border-slate-200 py-1 text-sm outline-none focus:border-orange-500">
                </div>
            </div>

            <div class="flex gap-3 mt-8">
                <button onclick="closeModal('editUserModal')" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold text-sm">å–æ¶ˆ</button>
                <button onclick="confirmUserEdit()" class="flex-1 py-3 bg-slate-900 text-white rounded-xl font-bold text-sm">ä¿å­˜èµ„æ–™</button>
            </div>
        </div>
    </div>

    <script>
        // Supabase Config
        const SUPABASE_URL = 'https://xxouixhnhauvgrrchako.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh4b3VpeGhuaGF1dmdycmNoYWtvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAxNTk2NjYsImV4cCI6MjA4NTczNTY2Nn0.ph24qP9wXOAvsblwkobH9MhSrDFJ4g5vyGof7aUjjVw';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let globalData = { users: [], tasks: [], currentUser: null };

        // Init
        window.addEventListener('DOMContentLoaded', async () => {
            await Promise.all([loadUsers(), loadPublishedTasks(), loadRate()]);
            loadUserProfile(); // åŠ è½½ä¸ªäººä¸­å¿ƒæ•°æ®
            renderDashboard();
            document.getElementById('loadingOverlay').style.display = 'none';
        });

        // Data Loading
        async function loadUsers() {
            const { data } = await supabase.from('01_user_master').select('*').order('created_at', {ascending: false});
            globalData.users = data || [];
        }

        async function loadPublishedTasks() {
            const { data } = await supabase.from('06_task_publish').select('*').order('created_at', {ascending: false});
            globalData.tasks = data || [];
        }

        async function loadRate() {
            const { data } = await supabase.from('08_exchange_rate').select('*').order('rate_date', {ascending: false}).limit(1);
            if(data && data[0]) {
                const rate = (data[0].xtransfer_mid * 0.99).toFixed(4);
                document.getElementById('header-rate').textContent = rate;
            }
        }

        // ä¸ªäººä¸­å¿ƒé€»è¾‘
        function loadUserProfile() {
            // å°è¯•ä» localStorage è·å–ç”¨æˆ·ï¼Œå¦‚æœæ²¡æœ‰åˆ™æ¨¡æ‹Ÿä¸€ä¸ªç®¡ç†å‘˜
            const storedUser = localStorage.getItem('baisheng_user');
            if (storedUser) {
                globalData.currentUser = JSON.parse(storedUser);
            } else {
                // å¦‚æœæ²¡æœ‰ç™»å½•ä¿¡æ¯ï¼Œä¸ºäº†æ¼”ç¤ºæ•ˆæœï¼Œæˆ‘ä»¬ä½¿ç”¨åˆ—è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªâ€œç®¡ç†å‘˜â€æˆ–â€œè¿è¥â€
                globalData.currentUser = globalData.users.find(u => u.role === 'ç®¡ç†å‘˜' || u.role === 'è¿è¥') || {
                    real_name: 'Emma (Demo)',
                    user_id: 'OPS-003',
                    role: 'è¿è¥',
                    email: '',
                    wechat: '',
                    whatsapp: ''
                };
            }

            const user = globalData.currentUser;
            const initials = user.real_name ? user.real_name.substring(0, 2).toUpperCase() : 'OP';
            
            document.getElementById('profile-avatar-large').textContent = initials;
            document.getElementById('profile-name').textContent = user.real_name || 'è¿è¥äººå‘˜';
            document.getElementById('profile-user-id').textContent = 'ID: ' + (user.user_id || 'OPS-003');
            
            // å¡«å……è¡¨å•
            document.getElementById('profile-email').value = user.email || '';
            document.getElementById('profile-wechat').value = user.wechat || '';
            document.getElementById('profile-whatsapp').value = user.whatsapp || '';
        }

        async function saveProfile() {
            const btn = document.getElementById('btn-save-profile');
            const originalText = btn.textContent;
            btn.textContent = 'ä¿å­˜ä¸­...';
            btn.disabled = true;

            const updates = {
                email: document.getElementById('profile-email').value,
                wechat: document.getElementById('profile-wechat').value,
                whatsapp: document.getElementById('profile-whatsapp').value
            };

            try {
                // å¦‚æœæ˜¯çœŸå®å­˜åœ¨çš„ç”¨æˆ·IDï¼ˆUUIDæ ¼å¼ï¼‰ï¼Œæ‰æ‰§è¡Œæ›´æ–°
                if (globalData.currentUser && globalData.currentUser.user_id && globalData.currentUser.user_id.length > 10) {
                    const { error } = await supabase
                        .from('01_user_master')
                        .update(updates)
                        .eq('user_id', globalData.currentUser.user_id);
                    if (error) throw error;
                    
                    // æ›´æ–°æœ¬åœ°ç¼“å­˜
                    globalData.currentUser = { ...globalData.currentUser, ...updates };
                    localStorage.setItem('baisheng_user', JSON.stringify(globalData.currentUser));
                    alert('âœ… ä¸ªäººèµ„æ–™ä¿å­˜æˆåŠŸï¼');
                } else {
                    alert('âš ï¸ æ¼”ç¤ºæ¨¡å¼ä¸‹æ— æ³•ä¿å­˜åˆ°æ•°æ®åº“ï¼Œä½†å‰ç«¯å·²æ›´æ–°ã€‚');
                }
            } catch (err) {
                alert('ä¿å­˜å¤±è´¥: ' + err.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        function logout() {
            if(confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                localStorage.removeItem('baisheng_user');
                window.location.reload();
            }
        }

        // Rendering
        function renderDashboard() {
            renderStats();
            renderTaskList();
            renderAuditList();
            renderUsers();
        }

        function renderStats() {
            document.getElementById('stat-pending-users').textContent = globalData.users.filter(u => u.status === 'å¾…å®¡æ ¸').length;
            document.getElementById('stat-active-tasks').textContent = globalData.tasks.filter(t => t.status === 'è¿›è¡Œä¸­').length;
            document.getElementById('stat-total-users').textContent = globalData.users.length;
        }

        function renderTaskList() {
            const container = document.getElementById('task-list-container');
            if(globalData.tasks.length === 0) {
                container.innerHTML = `<div class="col-span-3 text-center text-slate-400 py-10">æš‚æ— å‘å¸ƒçš„ä»»åŠ¡</div>`;
                return;
            }
            container.innerHTML = globalData.tasks.map(t => `
                <div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm relative group hover:-translate-y-1 transition-transform">
                    <span class="absolute top-4 right-4 px-2 py-1 bg-slate-100 text-slate-500 text-[10px] font-bold rounded">${t.target_role}</span>
                    <h3 class="font-bold text-slate-800 mb-2">${t.title}</h3>
                    <p class="text-xs text-slate-500 mb-4 h-10 overflow-hidden line-clamp-2">${t.content || 'æ— è¯¦ç»†æè¿°'}</p>
                    <div class="flex justify-between items-center text-[10px] font-bold text-slate-400 uppercase border-t border-slate-50 pt-4">
                        <span>æˆªæ­¢: ${t.deadline || 'é•¿æœŸ'}</span>
                        <span class="${t.status === 'è¿›è¡Œä¸­' ? 'text-green-500' : 'text-slate-300'}">${t.status}</span>
                    </div>
                </div>
            `).join('');
        }

        function renderAuditList() {
            const list = document.getElementById('audit-users-body');
            const pending = globalData.users.filter(u => u.status === 'å¾…å®¡æ ¸');
            list.innerHTML = pending.length ? pending.map(u => `
                <tr class="border-b border-slate-50">
                    <td class="p-4 pl-6 font-bold text-slate-700">${u.real_name}</td>
                    <td class="p-4"><span class="bg-slate-100 px-2 py-1 rounded text-[10px] font-bold text-slate-500">${u.role}</span></td>
                    <td class="p-4 text-xs text-slate-400">${u.id_card ? 'èº«ä»½è¯å·²æäº¤' : (u.passport ? 'æŠ¤ç…§å·²æäº¤' : 'æœªæäº¤')}</td>
                    <td class="p-4 text-right pr-6 space-x-2">
                        <button onclick="auditUser('${u.user_id}', 'å·²é€šè¿‡')" class="text-green-600 text-xs font-bold hover:underline">é€šè¿‡</button>
                        <button onclick="auditUser('${u.user_id}', 'å·²æ‹’ç»')" class="text-red-600 text-xs font-bold hover:underline">æ‹’ç»</button>
                    </td>
                </tr>
            `).join('') : `<tr><td colspan="4" class="p-6 text-center text-slate-400 text-xs">æš‚æ— å¾…å®¡æ ¸ç”¨æˆ·</td></tr>`;
        }

        function renderUsers() {
            const list = document.getElementById('users-list-body');
            const term = document.getElementById('search-input').value.toLowerCase();
            const filtered = globalData.users.filter(u => (u.real_name||'').toLowerCase().includes(term));
            
            list.innerHTML = filtered.map(u => {
                const referrerName = globalData.users.find(r => r.user_id === u.referrer_id)?.real_name || '-';
                return `
                <tr class="border-b border-slate-50 hover:bg-slate-50/50">
                    <td class="p-4 pl-6">
                        <div class="font-bold text-slate-800 text-sm">${u.real_name || 'æœªå‘½å'}</div>
                        <div class="text-[10px] text-slate-400">${u.phone || '-'}</div>
                    </td>
                    <td class="p-4"><span class="bg-orange-50 text-orange-700 px-2 py-1 rounded text-[10px] font-bold">${u.role}</span></td>
                    <td class="p-4 text-xs font-mono text-slate-500">P:${u.purchase_vip || 'æ— '} / S:${u.service_vip || 'æ— '}</td>
                    <td class="p-4 text-xs text-slate-500">${referrerName}</td>
                    <td class="p-4 text-right pr-6 space-x-2">
                        <button onclick="openAssignModal('${u.user_id}', '${u.real_name}')" class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded hover:bg-blue-100">åˆ†é…</button>
                        <button onclick="openEditUserModal('${u.user_id}')" class="text-xs font-bold text-slate-600 bg-slate-100 px-2 py-1 rounded hover:bg-slate-200">èµ„æ–™</button>
                    </td>
                </tr>
            `}).join('');
        }

        // Actions
        async function submitTask() {
            const title = document.getElementById('taskTitle').value;
            const content = document.getElementById('taskContent').value;
            const role = document.getElementById('taskRole').value;
            const deadline = document.getElementById('taskDeadline').value;

            if(!title) return alert('è¯·å¡«å†™æ ‡é¢˜');

            document.getElementById('loadingOverlay').style.display = 'flex';
            const { error } = await supabase.from('06_task_publish').insert({
                title, content, target_role: role, deadline: deadline || null
            });
            
            if(error) alert('å‘å¸ƒå¤±è´¥: ' + error.message);
            else {
                closeModal('taskModal');
                await loadPublishedTasks();
                renderDashboard();
            }
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        async function confirmAssignment() {
            const uid = document.getElementById('assignUserId').value;
            const refId = document.getElementById('newReferrerId').value;
            
            if(!refId) return alert('è¯·è¾“å…¥æ¨èäººID');
            
            document.getElementById('loadingOverlay').style.display = 'flex';
            const { error } = await supabase.from('01_user_master').update({ referrer_id: refId }).eq('user_id', uid);
            
            if(error) alert('åˆ†é…å¤±è´¥: ' + error.message);
            else {
                alert('åˆ†é…æˆåŠŸ');
                closeModal('assignModal');
                await loadUsers();
                renderDashboard();
            }
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        async function confirmUserEdit() {
            const uid = document.getElementById('editUserId').value;
            const updates = {
                email: document.getElementById('editEmail').value || null,
                wechat: document.getElementById('editWechat').value || null,
                whatsapp: document.getElementById('editWhatsapp').value || null
            };

            document.getElementById('loadingOverlay').style.display = 'flex';
            const { error } = await supabase.from('01_user_master').update(updates).eq('user_id', uid);
            
            if(error) alert('ä¿å­˜å¤±è´¥: ' + error.message);
            else {
                alert('èµ„æ–™æ›´æ–°æˆåŠŸ');
                closeModal('editUserModal');
                await loadUsers();
                renderDashboard();
            }
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        async function auditUser(uid, status) {
            if(!confirm(`ç¡®å®šæ ‡è®°è¯¥ç”¨æˆ·ä¸º ${status} å—ï¼Ÿ`)) return;
            document.getElementById('loadingOverlay').style.display = 'flex';
            await supabase.from('01_user_master').update({ status }).eq('user_id', uid);
            await loadUsers();
            renderDashboard();
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        // UI Helpers
        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('bg-orange-50', 'text-orange-700', 'font-bold');
                el.classList.add('text-slate-500');
            });
            document.getElementById('nav-' + id).classList.add('bg-orange-50', 'text-orange-700', 'font-bold');
        }

        function openModal(id) { document.getElementById(id).classList.remove('hidden'); }
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        
        function openAssignModal(uid, name) {
            document.getElementById('assignUserId').value = uid;
            document.getElementById('assignTargetName').textContent = 'æ­£åœ¨è°ƒæ•´: ' + name;
            openModal('assignModal');
        }

        function openEditUserModal(uid) {
            const user = globalData.users.find(u => u.user_id === uid);
            document.getElementById('editUserId').value = uid;
            document.getElementById('editEmail').value = user.email || '';
            document.getElementById('editWechat').value = user.wechat || '';
            document.getElementById('editWhatsapp').value = user.whatsapp || '';
            openModal('editUserModal');
        }
    </script>
</body>
</html>